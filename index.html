<!DOCTYPE html><html lang="es"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Simlish Translator ¬∑ ES ‚áÑ SIM ¬∑ Core v3.1</title>
<meta name="description" content="Traductor bidireccional Espa√±ol ‚áÑ Simlish con aprendizaje y sincronizaci√≥n estricta a backend.">
<meta http-equiv="Content-Security-Policy" content="default-src 'self';connect-src 'self' https://simlish-translator-backend.onrender.com;img-src 'self' https: data:;script-src 'self' 'unsafe-inline';style-src 'self' 'unsafe-inline';base-uri 'self';frame-ancestors 'self'">
<style>
:root{--bg:#06141a;--bg2:#071e24;--ink:#e6f7f4;--muted:#93c5c9;--line:#0f2e35;--accent:#22d3a6;--accent-strong:#10b981;--accent-warn:#eab308;--tiktok:#38bdf8}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 800px at 15% -10%,#0a2b2f 0,transparent 50%),linear-gradient(180deg,#041017,#06141a 35%,#06141a 100%);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;overflow-x:hidden}
header{padding:20px 24px;border-bottom:1px solid var(--line);background:#06141acc;backdrop-filter:blur(6px)}
h1{margin:0;font-size:1.25rem;display:flex;gap:10px;align-items:center}
.pill{display:inline-block;background:var(--accent);color:#04201a;padding:2px 10px;border-radius:999px;font-weight:800;font-size:.8rem}
.wrap{padding:20px 24px 28px;display:grid;gap:16px;max-width:1100px;margin:0 auto}
.grid{display:grid;gap:16px}@media(min-width:950px){.grid{grid-template-columns:1fr 1fr}}
.card{background:var(--bg2);border:1px solid var(--line);border-radius:16px;padding:16px}
label{display:block;margin-bottom:8px}
textarea,button,input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#071b20;color:var(--ink)}
textarea{min-height:170px;resize:vertical}
.row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
.btn{cursor:pointer;transition:filter .15s ease,transform .05s ease;background:linear-gradient(180deg,var(--accent) 0,var(--accent-strong) 100%);color:#052018;font-weight:800;border:none}
.btn:hover{filter:brightness(1.08)}.btn:active{transform:translateY(1px)}
.btn.sec{background:#071b20;border:1px solid var(--line);color:#2fe0bb;font-weight:600}
.out{white-space:pre-wrap;min-height:170px;border-radius:12px;border:1px dashed var(--line);padding:10px;background:#06141a;word-break:break-word;overflow-wrap:anywhere}
.muted{color:var(--muted);font-size:.92rem}.small{font-size:.85rem}
.chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#071b20;padding:6px 10px;border-radius:999px}
.state{display:flex;gap:8px;flex-wrap:wrap}.ok{color:var(--accent-strong)}.warn{color:var(--accent-warn)}
.dirbtn{display:flex;align-items:center;justify-content:center;gap:8px;font-weight:800;width:auto;min-width:180px}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#071b20;border:1px solid #2a2f40;border-bottom-width:2px;border-radius:6px;padding:1px 6px}
details summary{cursor:pointer}.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
a{color:var(--tiktok);text-decoration:none;font-weight:600}a:hover{text-decoration:underline}
.secret{max-width:1100px;margin:0 auto;padding:0 24px 12px}.list{display:grid;gap:8px;margin-top:8px}
.item{display:grid;gap:8px;border:1px dashed var(--line);border-radius:12px;padding:10px;background:#06181e}
.item .row2{display:grid;grid-template-columns:1fr 1fr auto auto;gap:8px}
.item small{color:var(--muted)}.chips{display:flex;gap:8px;flex-wrap:wrap}
.chipOpt{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#071b20;padding:6px 10px;border-radius:999px}
.confList{margin-top:10px;border:1px dashed var(--line);border-radius:12px;padding:10px;background:#06181e}
.confItem{padding:8px;border:1px solid var(--line);border-radius:10px;margin-top:8px;background:#071b20}
.importWrap{display:grid;gap:10px;margin-top:12px}.importActions{display:flex;gap:8px;flex-wrap:wrap}
.hint{font-size:.8rem;color:var(--muted)}
</style>
</head><body>
<header><h1>Simlish Translator <span class="pill">ES ‚áÑ SIM ¬∑ Core v3.1</span></h1></header>
<main class="wrap">
  <section class="grid">
    <div class="card">
      <div class="row" style="grid-template-columns:1fr auto">
        <label for="in" style="margin:0;align-self:center">Entrada</label>
        <button id="toggleDir" class="btn dirbtn" title="Cambiar direcci√≥n"><span id="dirLabel">ES ‚Üí SIM</span></button>
      </div>
      <textarea id="in" placeholder="Escribe aqu√≠."></textarea>
      <div class="row" style="margin-top:12px"><button id="translate" class="btn">Traducir</button><button id="clear" class="btn sec" title="Borrar texto">Limpiar</button></div>
      <p class="muted small">Aprendizaje estricto: sincroniza y guarda autom√°ticamente en el backend oficial.</p>
      <div class="toolbar"><button id="exportBtn" class="btn sec" title="Exportar respaldo">Exportar respaldo (.json)</button></div>
      <div id="strictBanner" class="small muted" style="display:none"></div>
    </div>
    <div class="card">
      <label for="out">Salida</label>
      <div id="out" class="out" aria-live="polite">--</div>
      <div class="row" style="margin-top:12px"><button id="copy" class="btn">Copiar</button><button id="demo" class="btn sec" title="Ejemplo r√°pido">Ejemplo</button></div>
      <div class="state" style="margin-top:12px">
        <span class="chip">Modo: <b>Estricto</b></span>
        <span class="chip">Direcci√≥n: <b id="stateDirVal">ES‚ÜíSIM</b></span>
        <span class="chip">Versi√≥n base: <b>3.1</b></span>
        <span class="chip">Aprendidos (√∫lt. op.): <b id="stateLearnVal">0</b></span>
        <span class="chip" id="confBadge" style="cursor:pointer" title="Ver conflictos">Conflictos: <b id="confCount">0</b></span>
        <span class="chip">Lex: <b id="metaLex">-</b></span>
        <span class="chip" id="hostChip" title="Estado de sincronizaci√≥n con host">Host: <b id="hostState">Listo</b></span>
      </div>
      <div id="confList" class="confList" style="display:none"></div>
    </div>
  </section>

  <section class="card">
    <details open><summary><strong>Historial (√∫ltimos 10 aprendidos)</strong></summary><div id="history" class="small muted" style="margin-top:8px">--</div></details>
    <details style="margin-top:12px"><summary><strong>Gram√°tica & Vocab cargados</strong></summary><div class="small muted" id="meta"></div></details>
    <p class="muted small" style="margin-top:10px">Tiempos: prefijos <span class="kbd">dra-</span>/<span class="kbd">to-</span>, sufijos <span class="kbd">-nu</span>/<span class="kbd">-ru</span> con auxiliar <span class="kbd">shoba</span>.</p>
  </section>

  <!-- ===== Panel secreto (admin) ===== -->
  <div class="secret">
    <div class="row" style="grid-template-columns:1fr auto">
      <input id="secretPass" type="password" placeholder="" aria-label=""/><button id="secretUnlock" class="btn" style="width:auto">OK</button>
    </div>
    <div id="secretPanel" class="card" style="display:none;margin-top:10px">
      <div class="chips" style="margin-bottom:8px">
        <label class="chipOpt"><input type="radio" name="mode" value="ES" checked> ES</label>
        <label class="chipOpt"><input type="radio" name="mode" value="SIM"> SIM</label>
        <button id="btnRescan" class="btn sec" style="margin-left:auto;width:auto">Re-escanear conflictos</button>
      </div>

      <!-- Buscar / editar -->
      <div class="row"><input id="searchQuery" placeholder="buscar‚Ä¶"/><button id="btnSearch" class="btn sec">Buscar</button></div>
      <div id="searchInfo" class="small muted" style="margin-top:6px">Edita solo pares de <b>Usuario</b>. CORE es de solo lectura.</div>
      <div id="results" class="list"></div>

      <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

      <!-- Crear manual (genera SIM √∫nico y guarda en USER) -->
      <div class="row"><input id="newEs" placeholder="Espa√±ol"/><input id="newSim" placeholder="(generado aqu√≠)"/></div>
      <div class="row" style="grid-template-columns:auto auto 1fr"><button id="btnGen" class="btn sec">Generar</button><button id="btnCreate" class="btn">Guardar</button><span class="small muted"></span></div>

      <hr style="border:none;border-top:1px solid var(--line);margin:16px 0">

      <!-- Importar respaldo -->
      <details open><summary><strong>Cargar respaldo (.json) ‚Äî Admin</strong></summary>
        <div class="importWrap">
          <div class="hint">Pega el JSON o selecciona un archivo exportado con ‚ÄúExportar respaldo (.json)‚Äù.</div>
          <div class="row" style="grid-template-columns:1fr auto">
            <textarea id="importJson" placeholder='Pega aqu√≠ el JSON del respaldo‚Ä¶'></textarea>
            <div style="display:flex;flex-direction:column;gap:8px">
              <input id="importFile" type="file" accept="application/json"/>
              <button id="btnLoadFile" class="btn sec" type="button" title="Leer archivo y volcar al cuadro">Leer archivo</button>
            </div>
          </div>
          <div class="importActions">
            <select id="importMode" title="Modo de carga" style="max-width:220px"><option value="merge">Fusionar (conservar y sumar)</option><option value="replace">Reemplazar (sobrescribe todo Usuario)</option></select>
            <button id="btnPreviewImport" class="btn sec" type="button">Previsualizar</button>
            <button id="btnDoImport" class="btn" type="button">Aplicar</button>
            <span id="importInfo" class="hint"></span>
          </div>
        </div>
      </details>

      <hr style="border:none;border-top:1px solid var(--line);margin:16px 0">
      <!-- üî• IMPORTANTE: La secci√≥n ‚ÄúMis pares (Usuario)‚Äù fue eliminada por completo -->
    </div>
  </div>
  <!-- ===== /Panel secreto ===== -->
</main>

<footer style="text-align:center;padding:16px;font-size:.85rem;color:var(--muted);border-top:1px solid var(--line);margin-top:24px">
  <a href="https://www.tiktok.com/@musimiau?_t=ZM-8stssM0VX78&_r=1" target="_blank">@musimiau en TikToküß°üíú</a><br>
  ‚òÜ Creado por <b style="color:var(--accent)">&nbsp;Musi Dklja&nbsp;</b> (28 de Agosto del 2025)
</footer>

<script>
/* ===================== CONFIG + HELPERS ===================== */
const CORE_VERSION="3.1",STRICT_MODE=true,KEY_USER=`simlishLexiconUser:${CORE_VERSION}`,KEY_HISTORY=`simlishLexiconHistory:${CORE_VERSION}`,DIR={ES2SIM:"ES2SIM",SIM2ES:"SIM2ES"};let CURRENT_DIR=DIR.ES2SIM,lastLearnedCount=0;
/* Backend forzado */
const BACKEND_URL="https://simlish-translator-backend.onrender.com/";let pushTimer=null,pulling=false,lastPushOk=null,dirtySinceLastPush=false;
/* Admin pass (SHA-256 hex) */
const PASS_SHA256_HEX="7f62619786ad59b250343204be7eba3b6adf943139684e185ab7234e8dc7d774";
async function verifyPass(pass){if(!window.crypto?.subtle)return false;const enc=new TextEncoder().encode(pass);const buf=await crypto.subtle.digest("SHA-256",enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("")===PASS_SHA256_HEX;}
const deacc=s=>String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),normEs=s=>deacc(String(s||"").toLowerCase()).trim(),normSim=s=>String(s||"").toLowerCase().trim();
function defaultUserStore(){return{es2sim:{},sim2es:{}}}
function loadUser(){try{return JSON.parse(localStorage.getItem(KEY_USER)||"")||defaultUserStore()}catch{return defaultUserStore()}}
function saveUser(store){try{localStorage.setItem(KEY_USER,JSON.stringify(store))}catch{} dirtySinceLastPush=true;schedulePushToHost()}
function loadHistory(){try{return JSON.parse(localStorage.getItem(KEY_HISTORY)||"[]")}catch{return[]}}
function saveHistory(list){try{localStorage.setItem(KEY_HISTORY,JSON.stringify(list.slice(-10)))}catch{} dirtySinceLastPush=true;schedulePushToHost()}
function canLearn(){return true}
let USER=loadUser(),HISTORY=loadHistory();

/* ===================== DATA (Core v3.1) ===================== */
const DATA={"gramatica":{"orden":"Sujeto ‚Äì Verbo ‚Äì Objeto (SVO)","adjetivo":"Despu√©s del sustantivo","posesion":"Con 'ta' ‚Üí Parshu ta meeba = mi pareja","negacion":{"nah":"no (simple)","nuvva":"nunca / negaci√≥n fuerte"},"plural":"Usar -s / -as / -us seg√∫n sonoridad","comparativos":{"moo":"m√°s","minnu":"menos","firbs":"muy"},"tiempos":{"auxiliar":"shoba = estar/ser","prefijos":{"dra-":"pasado","to-":"futuro"},"sufijos":{"-nu":"presente / en acto","-ru":"aspecto en curso"}},"interrogativos":{"harva":"qu√©/c√≥mo (general)","kujan":"c√≥mo (coloquial)"},"conectores":{"plubbu":"y/pero","ta":"de/que/para/a","wit":"con","palu":"para","entru":"entonces","kuzra":"porque","thooba":"aunque","sooba":"as√≠ que","hovra":"sin embargo","pleebu":"si / por ejemplo"},"adverbios_tiempo":{"nuvra":"ahora","yestu":"ayer","todra":"antes","tombru":"ma√±ana","soonru":"pronto","dovra":"noche","sulah":"d√≠a"}},"calendario":{"dias":["Lurnas","Tarnas","Mernas","Juvnas","Virnas","Sabnas","Domnas"],"meses":["Enmar","Febmar","Tramar","Avramar","Majmar","Junmar","Julmar","Gostmar","Septmar","Oktmar","Novmar","Zimbar"]},"vocabulario":{"pronombres":{"meeba":"yo","teeba":"t√∫","heeba":"√©l","sheba":"ella","weeba":"nosotros","da":"el/la/los/las"},"basicos":{"yibu":"s√≠","nah":"no","nuvva":"nunca","sul sul":"hola","su laa":"bienvenidos","dag dag":"chao","da vaa":"adi√≥s","felnu":"perd√≥n","firvu":"bien hecho","whazzu":"¬øqu√© pasa?","frezzu":"felicidades","vrashoo":"ojal√°","welbru":"bienvenido","oddru":"otro","gratvu":"gracias","prezooba":"bonito/hermoso","nibbu":"beb√©"},"lugares":{"varkun":"mercado","savrak":"escuela","tavruu":"taberna","domru":"templo","karshu":"c√°rcel","frambu":"granja","talvak":"taller","citra":"pueblo","shorva-midru":"plaza central"},"casa":{"grivna":"pared","tavnek":"techo","grundal":"suelo","ventra":"ventana","dorvu":"puerta","skravla":"escalera","plavru":"patio","fumrak":"chimenea","slumbaa":"cama","trabka":"mesa","krinta":"silla","garvun":"armario","lumbru":"sof√°","sholvik":"estante","glimra":"l√°mpara"},"naturaleza":{"dravun":"√°rbol","lurvak":"bosque","rivru":"r√≠o","lagru":"lago","morvak":"mar","mornak":"monta√±a","vallru":"valle","plavna":"pradera","skavru":"cielo","nubba":"nube","sulvar":"sol","lunvar":"luna","strovna":"estrella","wairnu":"viento","grunva":"tierra"},"clima":{"shusha":"lluvia","bravruu":"tormenta","drovak":"trueno","skrashu":"rayo/rel√°mpago","flavru":"nieve","kravnu":"granizo","hetru":"calor","friznu":"fr√≠o","grovna":"nube oscura","prismoo":"arco√≠ris"},"cocina":{"fooba":"comida","shubra":"ropa","lavru":"lavar","olbru":"olla","frilpa":"sart√©n","klivra":"cuchillo","spuvu":"cuchara","platru":"plato","glavru":"vaso","ovrak":"horno","stovru":"fuego de cocina"},"verbos_cotidianos":{"brazu":"cocinar","nomma":"comer","gluppa":"beber","delvu":"servir","klasha":"cortar","mashka":"masticar","travnu":"ir/ir a","gavna":"tener","dropra":"dejar caer","workru":"trabajar","zurnu":"ganas/√°nimo","showru":"aparecer/mostrar(se)"},"sabores_estado":{"tastu":"sabrosa","friznu":"fr√≠o","brasha":"caliente","swibbu":"dulce","salgru":"salada","bitra":"amarga","sharvu":"picante","tartu":"√°cida","fluska":"limpio"},"cuerpo":{"kavra":"cabeza","manru":"mano","okru":"ojo","mokra":"boca","legra":"pierna","podru":"pie","krovna":"coraz√≥n","bonka":"hueso","skarna":"piel"},"organos":{"bravna":"cerebro","stomru":"est√≥mago","lungra":"pulmones","livru":"h√≠gado","kidru":"ri√±√≥n","krovak":"sangre","alvra":"alma","introv":"intestino","zanvak":"eterno"},"sentidos":{"vooba":"ver","lurmu":"o√≠r","snorva":"oler","gustra":"saborear","takru":"tocar","senvra":"sentir","perklu":"percibir"},"emociones":{"jibnu":"feliz","mavruu":"triste","dranza":"cansado","blennu":"aburrido","franvu":"preocupado","satruu":"satisfecho","sumba":"calmado","zenvru":"celoso","pravna":"orgulloso","shombra":"avergonzado","gratru":"agradecido","truval":"confiado","timbru":"t√≠mido"},"valores":{"jusvak":"justicia","kindru":"bondad","dravru":"maldad","onrak":"honor","loybru":"lealtad","savra":"sabidur√≠a"},"relaciones":{"klavu":"amigo","onbru":"solo","neebu":"vecino","vorna":"l√≠der","zorvik":"enemigo","stravru":"desconocido","sambru":"compa√±ero","parshu":"pareja","lomvak":"maestro","savba":"ense√±ar","savnu":"aprender","savrin":"aprendiz"},"animales":{"mivvu":"gato","woofum":"perro","chirva":"ave/p√°jaro","bluppa":"pez","tranka":"caballo","bovru":"vaca","skivvi":"rat√≥n","vulka":"zorro","snorka":"cerdo","balmu":"oveja"},"tecnologia_epico":{"netvra":"internet","stabru":"estable","zavrush":"aventuras"},"narrativa_raices":{"zombru":"guiar/liderar (√©pico)","gravnu":"aldea/ciudad grande","flowru":"flujo espiritual/energ√≠a","shobru":"mostrar/revelar"},"custom":{"plarvoh":"ma√±ana","nurplah":"juguemos"}},"phrasebook":{"saludos":{"Sul sul!":"¬°Hola!","Su laa!":"¬°Bienvenidos!","Dag dag!":"¬°Chao!","Da vaa.":"Adi√≥s."},"cotidianas":{"Meeba gavna ta travnu ta lavru shubra, plubbu meeba gavna nuvva zurnu.":"Tengo que ir a lavar ropa y no tengo ganas.","Meeba brazu supa brasha.":"Cocino sopa caliente.","Delvu da supa wit spuvu.":"Sirve la sopa con la cuchara.","Meeba gluppa tivra brasha.":"Bebo t√© caliente."},"vivo_humor_picante":{"Chobba entru":"Ch√∫palo entonces","Meeba travnu dropla da shusha":"Voy a dejar caer la lluvia","Zemma fruuvy":"Semencito rico","Klavash":"Culear","Zorva":"Zorra","Plumba fruuvy":"Pene rico","Zabbo palu da vooba":"Pico pal que lee"},"tiernas":{"Puzzaa, meeba wrongru.":"Pucha, me equivoqu√©.","Aiaiyu, da hurtru brumba.":"Ayayay, qu√© dolor grande.","Nyeee, meeba nah sulah.":"√ëeee, no quiero.","Shishi, da funnu.":"Jijiji, qu√© chistoso."},"tecnologia_deseo":{"Vrashoo ta netvra shoba stabru, klavrus Musisitos.":"Ojal√° que el internet est√© estable, queridos Musisitos."},"extras_calendario":{"Nuvra shoba Lurnas.":"Hoy es lunes.","Tombru shoba Tarnas.":"Ma√±ana ser√° martes.","Ta Mernas weeba playru Simms.":"El mi√©rcoles jugamos Sims."},"garabatos_chilenismos":{"Krabbo tuvorna":"Ctm","Da dravva":"La dura","Noobru klavrak":"Cabro ql","Chuvra":"Chucha","Putra da wobru":"Puta la wea","Palu da krabba":"Pa' la cag√°","Travnu wobru-shaka":"And√°i puro webiando","Kon kruva":"Con cuea"}}};

/* ===================== √çNDICES CORE + PHRASEBOOK ===================== */
let CORE_ES2SIM=new Map(),CORE_SIM2ES=new Map(),PH_ES2SIM=new Map(),PH_SIM2ES=new Map();
(function buildCore(){
  for(const entries of Object.values(DATA.vocabulario)){for(const[sim,es]of Object.entries(entries)){const espNorm=normEs(es),simNorm=normSim(sim);const variants=espNorm.split(/[\/,]/).map(s=>s.trim()).filter(Boolean);for(const v of variants){if(!CORE_ES2SIM.has(v)) CORE_ES2SIM.set(v,sim)} if(!CORE_SIM2ES.has(simNorm)) CORE_SIM2ES.set(simNorm,es.split('/')[0]);}}
  for(const group of Object.values(DATA.phrasebook||{})){for(const[sim,es]of Object.entries(group)){PH_ES2SIM.set(normEs(es),sim);PH_SIM2ES.set(normSim(sim),es);}}
})();

/* ===================== Multi-palabras SIM ===================== */
function getMultiSimKeys(){const keys=new Set();for(const entries of Object.values(DATA.vocabulario||{})){for(const sim of Object.keys(entries||{})){if(sim.includes(" ")) keys.add(sim.toLowerCase());}}
for(const sim of Object.keys((USER&&USER.sim2es)||{})){if(sim&&sim.includes(" ")) keys.add(sim.toLowerCase());}
for(const grp of Object.values(DATA.phrasebook||{})){for(const sim of Object.keys(grp)){if(sim.includes(" ")) keys.add(sim.toLowerCase());}}
return Array.from(keys).sort((a,b)=>b.length-a.length)}
function compressMultiSim(text){let out=text;for(const key of getMultiSimKeys()){const escaped=key.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");const re=new RegExp(`\\b${escaped}\\b`,"gi");out=out.replace(re,m=>m.replace(/\s+/g,"_"))}return out}
const expandMultiSimToken=t=>t.replace(/_/g," ");

/* ===================== Helpers ===================== */
function currentSimOwner(sim){const k=normSim(sim);if(USER.sim2es[k]) return{scope:"USER",es:USER.sim2es[k]};if(CORE_SIM2ES.has(k)) return{scope:"CORE",es:CORE_SIM2ES.get(k)};return null}
function preserveCase(o,r){return/^[A-Z]/.test(o)?r.charAt(0).toUpperCase()+r.slice(1):r}
function ensureUniqueSim(sim,es){let base=normSim(sim);const owner=currentSimOwner(base);if(!owner||normEs(owner.es).includes(normEs(es))) return sim;const suff=["ah","eh","oh","nu","ru","va","la","ra","ba"];for(const s of suff){const cand=base+s;if(!currentSimOwner(cand)) return preserveCase(sim,cand)}let i=2;while(currentSimOwner(base+i)) i++;return preserveCase(sim,base+i)}
function esSynSet(esStr){const raw=String(esStr||"");return new Set(raw.split(/[\/,]/).map(s=>normEs(s)).filter(Boolean))}

/* ===================== Detecci√≥n simlish ===================== */
const SYLL=["su","la","noo","boo","zim","zam","sha","bah","voh","plar","gib","yib","flo","fru","doo","ka","ru","shi","ku","va","na","mo","ta","re","lo"];
function looksSimlish(word){const w=normSim(word);if(!w) return false;if(USER.sim2es[w]||CORE_SIM2ES.has(w)) return true;if(/^[a-z_]+$/.test(w)===false) return false;if(w.length<=2) return false;const syllHits=SYLL.reduce((n,syl)=>n+(w.includes(syl)?1:0),0);if(/^(dra-|to-)/.test(w)||/(-nu|-ru)$/.test(w)) return true;return syllHits>=2}

/* ===================== Conflictos ===================== */
function scanConflicts(){const coreSyn=new Map();for(const entries of Object.values(DATA.vocabulario)){for(const[sim,es]of Object.entries(entries)){const s=normSim(sim),set=esSynSet(es);coreSyn.set(s,new Set([...(coreSyn.get(s)||[]),...set]))}}const bySim=new Map();for(const[simNorm,set]of coreSyn.entries()) bySim.set(simNorm,[set]);for(const[sim,es]of Object.entries(USER.sim2es||{})){const kSim=normSim(sim),set=esSynSet(es);if(!bySim.has(kSim)) bySim.set(kSim,[]);let groups=bySim.get(kSim),merged=false;for(const g of groups){const inter=[...set].some(x=>g.has(x));if(inter){for(const x of set) g.add(x);merged=true;break}}if(!merged) groups.push(set)}for(const[es,sim]of Object.entries(USER.es2sim||{})){const kSim=normSim(sim),set=esSynSet(es);if(!bySim.has(kSim)) bySim.set(kSim,[]);let groups=bySim.get(kSim),merged=false;for(const g of groups){const inter=[...set].some(x=>g.has(x));if(inter){for(const x of set) g.add(x);merged=true;break}}if(!merged) groups.push(set)}const conflicts=[];for(const[sim,groups]of bySim.entries()){const compact=groups.filter(g=>g&&g.size>0);if(compact.length>1) conflicts.push({sim,groups:compact.map(g=>Array.from(g))})}return conflicts}
function resolveConflictBySynonyms(simKey){const sim=normSim(simKey),confs=scanConflicts().find(c=>normSim(c.sim)===sim);if(!confs){alert("No hay conflicto detectable para "+simKey);return}const unionEs=Array.from(new Set(confs.groups.flat())).sort(),esJoined=unionEs.join(" / ");USER.sim2es[sim]=esJoined;for(const es of unionEs){const kEs=normEs(es);const prevSim=USER.es2sim[kEs];if(prevSim&&normSim(prevSim)!==sim){delete USER.sim2es[normSim(prevSim)]}USER.es2sim[kEs]=sim}saveUser(USER);refreshMeta();alert("Conflicto resuelto. SIM: "+simKey+" ‚áÑ ES: "+esJoined)}

/* ===================== Tiempos + Aprendizaje ===================== */
function xorshift32(seed){let x=seed|0;return()=> (x^=x<<13,x^=x>>>17,x^=x<<5,(x>>>0)/4294967296)}
function hashStr(s){let h=2166136261>>>0;for(const c of s) h=Math.imul(h^c.charCodeAt(0),16777619);return h>>>0}
function synth(word){const w=normEs(word).replace(/[^a-z0-9\s]/g,"");if(!w) return word;const rnd=xorshift32(hashStr(w));let n=Math.max(2,Math.min(4,Math.ceil(w.length/4)));let out=[];for(let i=0;i<n;i++) out.push(SYLL[Math.floor(rnd()*SYLL.length)]);let res=out.join("");if(/r$/.test(w)) res+="ru";if(/n$/.test(w)) res+="nu";return ensureUniqueSim(res,word)}
function learnPairs(pairs){let learned=0,stamped=[];for(const[esRaw,simRaw]of pairs){const es=String(esRaw||"").trim(),sim1=String(simRaw||"").trim();if(!es) continue;const sim=ensureUniqueSim(sim1||synth(es),es);const kEs=normEs(es),kSim=normSim(sim);if(!kSim) continue;const prevSim=USER.es2sim[kEs];if(prevSim&&normSim(prevSim)!==kSim){delete USER.sim2es[normSim(prevSim)]}const prevEs=USER.sim2es[kSim];if(prevEs&&normEs(prevEs)!==kEs){delete USER.es2sim[normEs(prevEs)]}if(!USER.es2sim[kEs]){USER.es2sim[kEs]=sim;learned++}if(!USER.sim2es[kSim]) USER.sim2es[kSim]=es;stamped.push({es,sim,t:new Date().toISOString()})}
if(stamped.length){HISTORY=[...HISTORY,...stamped].slice(-10);saveHistory(HISTORY)}if(learned>0) saveUser(USER);return learned}

/* ===================== Traducci√≥n ===================== */
const adv=DATA.gramatica.adverbios_tiempo||{},PAST_LEX=new RegExp("\\b("+["ayer","antes","ya",adv.yestu,"anoche"].filter(Boolean).join("|")+")\\b","i"),FUT_LEX=new RegExp("\\b("+["ma√±ana","manana","luego","despu√©s","despues","pronto",adv.tombru].filter(Boolean).join("|")+")\\b","i");
function applyTense(simWord,txt){if(PAST_LEX.test(txt)) return "dra-"+simWord; if(FUT_LEX.test(txt)) return "to-"+simWord; return simWord}
function tokenizeEs(s){return s.split(/(\s+|[.,;:!?()"'¬°¬ø])/).filter(x=>x!==undefined&&x!=="")}
function translateEs2Sim(text){const tokens=tokenizeEs(text);const compressed=compressMultiSim(text);const tks=tokenizeEs(compressed);const out=[];for(const tk of tks){if(/\s+|[.,;:!?()"'¬°¬ø]/.test(tk)){out.push(tk);continue}if(/_/.test(tk)){const w=expandMultiSimToken(tk);const hit=PH_ES2SIM.get(normEs(w))||CORE_ES2SIM.get(normEs(w))||USER.es2sim[normEs(w)]||synth(w);out.push(applyTense(hit,text));continue}const key=normEs(tk);let sim=PH_ES2SIM.get(key)||CORE_ES2SIM.get(key)||USER.es2sim[key];if(!sim){sim=synth(tk)}out.push(applyTense(preserveCase(tk,sim),text))}return out.join("")}
function translateSim2Es(text){const parts=text.split(/(\s+|[.,;:!?()"'¬°¬ø])/).filter(x=>x!==undefined&&x!=="");const out=[];for(const tk of parts){if(/\s+|[.,;:!?()"'¬°¬ø]/.test(tk)){out.push(tk);continue}let w=normSim(tk).replace(/^(dra-|to-)/,"").replace(/(-nu|-ru)$/,"");const es=PH_SIM2ES.get(w)||USER.sim2es[w]||CORE_SIM2ES.get(w)||tk;out.push(preserveCase(tk,es))}return out.join("")}

/* ===================== Host sync (estricto) ===================== */
async function pullFromHost(){if(pulling) return;pulling=true;try{const r=await fetch(BACKEND_URL+"pull?version="+encodeURIComponent(CORE_VERSION));if(!r.ok) throw new Error("pull "+r.status);const data=await r.json();if(data?.user){USER=data.user;saveUser(USER)}if(Array.isArray(data?.history)){HISTORY=data.history.slice(-10);saveHistory(HISTORY)}document.getElementById("hostState").textContent="Sincronizado"}catch(e){document.getElementById("hostState").textContent="Offline"}finally{pulling=false}}
function schedulePushToHost(){clearTimeout(pushTimer);pushTimer=setTimeout(pushToHost,900)}
async function pushToHost(){if(!dirtySinceLastPush)return;try{const r=await fetch(BACKEND_URL+"push",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({version:CORE_VERSION,user:USER,history:HISTORY})});lastPushOk=r.ok;dirtySinceLastPush=false;document.getElementById("hostState").textContent=r.ok?"Enviado":"Error"}catch{document.getElementById("hostState").textContent="Offline"}}

/* ===================== UI ===================== */
function refreshHistory(){const $h=document.getElementById("history");$h.textContent=(HISTORY&&HISTORY.length)?HISTORY.map(x=>`${x.es} ‚áÑ ${x.sim}`).join(" ¬∑ "):"--"}
function refreshMeta(){const lex=Object.keys(USER.es2sim||{}).length+"/"+Object.keys(USER.sim2es||{}).length;document.getElementById("metaLex").textContent=lex;const conflicts=scanConflicts();document.getElementById("confCount").textContent=conflicts.length;const $list=document.getElementById("confList");$list.style.display=conflicts.length?"block":"none";$list.innerHTML=conflicts.map(c=>`<div class="confItem"><b>${c.sim}</b><div class="small">ES: ${c.groups.map(g=>g.join(", ")).join(" | ")}</div><button class="btn sec" onclick="resolveConflictBySynonyms('${c.sim.replace(/'/g,"&#39;")}')">Unificar sin√≥nimos</button></div>`).join("")}
function refreshState(){document.getElementById("stateDirVal").textContent=(CURRENT_DIR===DIR.ES2SIM)?"ES‚ÜíSIM":"SIM‚ÜíES";document.getElementById("stateLearnVal").textContent=lastLearnedCount}
function setOut(v){document.getElementById("out").textContent=v||"--"}
function copyOut(){navigator.clipboard?.writeText(document.getElementById("out").textContent||"")}

/* ===================== Admin (sin ‚ÄúMis pares‚Äù) ===================== */
async function unlockAdmin(){const pass=(document.getElementById("secretPass")?.value||"").trim();const ok=await verifyPass(pass);if(ok){document.getElementById("secretPanel").style.display="block"}else{alert("Clave incorrecta")}}
function searchLex(q,mode){q=normEs(q);const rows=[];if(mode==="ES"){const fromCore=[[...CORE_ES2SIM.entries()].map(([k,v])=>({k,v,scope:"CORE"})),Object.entries(USER.es2sim||{}).map(([k,v])=>({k,v,scope:"USER"}))].flat().filter(x=>x.k.includes(q)).slice(0,80);for(const it of fromCore){rows.push({es:it.k,sim:it.v,scope:it.scope})}}else{const fromCore=[[...CORE_SIM2ES.entries()].map(([k,v])=>({k,v,scope:"CORE"})),Object.entries(USER.sim2es||{}).map(([k,v])=>({k,v,scope:"USER"}))].flat().filter(x=>x.k.includes(q)).slice(0,80);for(const it of fromCore){rows.push({es:it.v,sim:it.k,scope:it.scope})}}return rows}
function renderResults(items){const $r=document.getElementById("results");$r.innerHTML=items.map((it,i)=>`<div class="item"><div class="row2"><input id="e_es_${i}" value="${it.es}"/><input id="e_sim_${i}" value="${it.sim}"/><button class="btn sec" onclick="upd(${i})">Actualizar</button><button class="btn" onclick="delp(${i})">Borrar</button></div><small>Scope: ${it.scope}</small></div>`).join("");$r._items=items}
function upd(i){const items=document.getElementById("results")._items||[];const it=items[i];if(!it){return}const es=document.getElementById(`e_es_${i}`).value,sim=document.getElementById(`e_sim_${i}`).value;if(!es||!sim){alert("Campos vac√≠os");return}const kEs=normEs(es),kSim=normSim(sim);if(it.scope==="CORE"){alert("CORE es de solo lectura");return}USER.es2sim[kEs]=sim;USER.sim2es[kSim]=es;saveUser(USER);refreshMeta();alert("Actualizado")}
function delp(i){const items=document.getElementById("results")._items||[];const it=items[i];if(!it){return}if(it.scope==="CORE"){alert("CORE es de solo lectura");return}delete USER.es2sim[normEs(it.es)];delete USER.sim2es[normSim(it.sim)];saveUser(USER);refreshMeta();document.getElementById("results").children[i]?.remove()}
function genSim(){const es=(document.getElementById("newEs")?.value||"").trim();if(!es){alert("Escribe una palabra/fras e");return}document.getElementById("newSim").value=ensureUniqueSim(synth(es),es)}
function createPair(){const es=(document.getElementById("newEs")?.value||"").trim(),sim=(document.getElementById("newSim")?.value||"").trim();if(!es||!sim){alert("Faltan campos");return}const learned=learnPairs([[es,sim]]);lastLearnedCount=learned;refreshState();refreshHistory();refreshMeta();alert("Guardado")}

/* ===================== Respaldo (import/export) ===================== */
function exportBackup(){const payload={user:USER,history:HISTORY};const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=`simlish_backup_v${CORE_VERSION}.json`;a.click();URL.revokeObjectURL(a.href)}
function normalizeBackupJSON(text){if(!text||!text.trim()) throw new Error("JSON vac√≠o.");let obj;try{obj=JSON.parse(text)}catch{throw new Error("JSON inv√°lido.")}let userLike=null,historyLike=[];if(obj&&obj.user&&(obj.user.es2sim||obj.user.sim2es)){userLike=obj.user;if(Array.isArray(obj.history)) historyLike=obj.history.slice(-10)}else if(obj&&(obj.es2sim||obj.sim2es)){userLike={es2sim:obj.es2sim||{},sim2es:obj.sim2es||{}};if(Array.isArray(obj.history)) historyLike=obj.history.slice(-10)}else{throw new Error("Formato no reconocido. Se esperaba {user:{es2sim,sim2es}} o {es2sim,sim2es}.")}userLike.es2sim=userLike.es2sim||{};userLike.sim2es=userLike.sim2es||{};if(typeof userLike.es2sim!=="object"||typeof userLike.sim2es!=="object") throw new Error("Estructura de diccionario inv√°lida.");return{user:userLike,history:historyLike}}
function computeBackupStats(parsed){const es2sim=Object.keys(parsed.user.es2sim||{}).length,sim2es=Object.keys(parsed.user.sim2es||{}).length,hist=Array.isArray(parsed.history)?parsed.history.length:0;return{es2sim,sim2es,history:hist}}
function applyBackup(parsed,mode){const srcES2SIM=parsed.user.es2sim||{},srcSIM2ES=parsed.user.sim2es||{},srcHIST=Array.isArray(parsed.history)?parsed.history.slice(-10):[];let appliedEs2Sim=0,appliedSim2Es=0,historyApplied=0;if(mode==="replace"){USER={es2sim:{},sim2es:{}}}
for(const[es,sim]of Object.entries(srcES2SIM)){const kEs=normEs(es);let simVal=String(sim||"").trim();if(!kEs||!simVal) continue;simVal=ensureUniqueSim(simVal,es);const kSim=normSim(simVal);const prevSim=USER.es2sim[kEs];if(prevSim&&normSim(prevSim)!==kSim){delete USER.sim2es[normSim(prevSim)]}const prevEs=USER.sim2es[kSim];if(prevEs&&normEs(prevEs)!==kEs){delete USER.es2sim[normEs(prevEs)]}if(USER.es2sim[kEs]!==simVal) appliedEs2Sim++;USER.es2sim[kEs]=simVal;USER.sim2es[kSim]=es}
for(const[sim,es]of Object.entries(srcSIM2ES)){const kSim=normSim(sim),kEs=normEs(es);if(!kSim||!kEs) continue;const prevEs=USER.sim2es[kSim];if(prevEs&&normEs(prevEs)!==kEs){delete USER.es2sim[normEs(prevEs)]}const prevSim=USER.es2sim[kEs];if(prevSim&&normSim(prevSim)!==kSim){delete USER.sim2es[normSim(prevSim)]}if(USER.sim2es[kSim]!==es) appliedSim2Es++;USER.sim2es[kSim]=es;USER.es2sim[kEs]=sim}
if(srcHIST.length){HISTORY=[...HISTORY,...srcHIST].slice(-10);historyApplied=srcHIST.length;saveHistory(HISTORY)}saveUser(USER);return{appliedEs2Sim,appliedSim2Es,historyApplied}}

/* ===================== Eventos ===================== */
function init(){
  const $in=document.getElementById("in"),$out=document.getElementById("out"),$dirLabel=document.getElementById("dirLabel");
  document.getElementById("translate")?.addEventListener("click",()=>{const txt=$in.value||"";let res=CURRENT_DIR===DIR.ES2SIM?translateEs2Sim(txt):translateSim2Es(txt);setOut(res)});
  document.getElementById("toggleDir")?.addEventListener("click",()=>{CURRENT_DIR=(CURRENT_DIR===DIR.ES2SIM)?DIR.SIM2ES:DIR.ES2SIM;$dirLabel.textContent=(CURRENT_DIR===DIR.ES2SIM)?"ES ‚Üí SIM":"SIM ‚Üí ES";refreshState()});
  document.getElementById("clear")?.addEventListener("click",()=>{$in.value="";setOut("--")});
  document.getElementById("copy")?.addEventListener("click",copyOut);
  document.getElementById("demo")?.addEventListener("click",()=>{$in.value="Hola, ma√±ana lavamos ropa y despu√©s jugamos.";setOut(CURRENT_DIR===DIR.ES2SIM?translateEs2Sim($in.value):translateSim2Es($in.value))});
  document.getElementById("exportBtn")?.addEventListener("click",exportBackup);
  document.getElementById("confBadge")?.addEventListener("click",()=>{const e=document.getElementById("confList");e.style.display=e.style.display==="none"?"block":"none"});
  document.getElementById("secretUnlock")?.addEventListener("click",unlockAdmin);
  document.getElementById("btnSearch")?.addEventListener("click",()=>{const q=document.getElementById("searchQuery").value||"";const mode=document.querySelector('input[name="mode"]:checked')?.value||"ES";renderResults(searchLex(q,mode))});
  document.getElementById("btnGen")?.addEventListener("click",genSim);
  document.getElementById("btnCreate")?.addEventListener("click",createPair);
  document.getElementById("btnRescan")?.addEventListener("click",()=>refreshMeta());

  // Import UI
  const $importJson=document.getElementById("importJson"),$importFile=document.getElementById("importFile"),$btnLoadFile=document.getElementById("btnLoadFile"),$btnPreviewImport=document.getElementById("btnPreviewImport"),$btnDoImport=document.getElementById("btnDoImport"),$importInfo=document.getElementById("importInfo"),$importMode=document.getElementById("importMode");
  function readSelectedFileIntoTextarea(){if(!$importFile?.files?.length){alert("Selecciona un archivo .json primero.");return}const file=$importFile.files[0];file.text().then(text=>{$importJson.value=text;$importInfo.textContent="Archivo le√≠do. Previsualiza o aplica cuando quieras."}).catch(()=>{$importInfo.textContent="No se pudo leer el archivo."})}
  $btnLoadFile?.addEventListener("click",readSelectedFileIntoTextarea);
  if($importFile&&!$importFile._boundChange){$importFile._boundChange=true;$importFile.addEventListener("change",readSelectedFileIntoTextarea)}
  $btnPreviewImport?.addEventListener("click",()=>{try{const parsed=normalizeBackupJSON($importJson.value);const stats=computeBackupStats(parsed);$importInfo.textContent=`Detectado: ES‚ÜíSIM: ${stats.es2sim} ¬∑ SIM‚ÜíES: ${stats.sim2es} ¬∑ Historial: ${stats.history}`}catch(e){$importInfo.textContent=`Error: ${e.message}`}})
  $btnDoImport?.addEventListener("click",()=>{try{const parsed=normalizeBackupJSON($importJson.value);const mode=($importMode?.value)||"merge";if(mode==="replace"){if(!confirm("Vas a REEMPLAZAR completamente el diccionario de Usuario por el respaldo. ¬øContinuar?")) return;}const stats=applyBackup(parsed,mode);$importInfo.textContent=`Aplicado (${mode}). ES‚ÜíSIM: +${stats.appliedEs2Sim} ¬∑ SIM‚ÜíES: +${stats.appliedSim2Es} ¬∑ Historial: ${stats.historyApplied}`;if($importFile) $importFile.value="";refreshMeta();alert("Respaldo aplicado correctamente.")}catch(e){alert("No se aplic√≥ el respaldo: "+e.message)}});

  refreshHistory();refreshMeta();refreshState();pullFromHost();
}
document.addEventListener("DOMContentLoaded",init);
</script>
</body></html>
