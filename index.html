<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Simlish Translator ¬∑ ES ‚áÑ SIM ¬∑ Core v3.1</title>
<meta name="description" content="Traductor bidireccional Espa√±ol ‚áÑ Simlish con aprendizaje, panel admin, Sim Chat y conexi√≥n a backend/ML.">
<!-- CSP m√≠nima (self + Render) -->
<meta http-equiv="Content-Security-Policy"
  content="default-src 'self';
           connect-src 'self' https://simlish-translator-backend.onrender.com;
           img-src 'self' https: data:;
           script-src 'self' 'unsafe-inline';
           style-src  'self' 'unsafe-inline';
           base-uri 'self';
           frame-ancestors 'self'">
<style>
  :root{ --bg:#06141a; --bg2:#071e24; --ink:#e6f7f4; --muted:#93c5c9; --line:#0f2e35; --accent:#22d3a6; --accent-strong:#10b981; --accent-warn:#eab308; --danger:#ef4444; --tiktok:#38bdf8; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; background:radial-gradient(1200px 800px at 15% -10%, #0a2b2f 0%, transparent 50%), linear-gradient(180deg,#041017,#06141a 35%, #06141a 100%); color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; overflow-x:hidden; }
  header{padding:20px 24px;border-bottom:1px solid var(--line);background:#06141acc;backdrop-filter:blur(6px)}
  h1{margin:0;font-size:1.25rem;display:flex;gap:10px;align-items:center}
  .pill{display:inline-block;background:var(--accent);color:#04201a;padding:2px 10px;border-radius:999px;font-weight:800;font-size:.8rem}
  .wrap{padding:20px 24px 28px;display:grid;gap:16px;max-width:1100px;margin:0 auto}
  .grid{display:grid;gap:16px}
  @media(min-width:950px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--bg2);border:1px solid var(--line);border-radius:16px;padding:16px}
  label{display:block;margin-bottom:8px}
  textarea,button,input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#071b20;color:var(--ink)}
  textarea{min-height:170px;resize:vertical}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .row.auto{grid-template-columns:auto 1fr}
  .btn{cursor:pointer;transition:filter .15s ease, transform .05s ease;background:linear-gradient(180deg,var(--accent) 0%, var(--accent-strong) 100%);color:#052018;font-weight:800;border:none}
  .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
  .btn.sec{background:#071b20;border:1px solid var(--line);color:var(--ink);font-weight:600}
  .btn.danger{background:#7a1212;border:1px solid #a01c1c;color:#fff}
  .out{white-space:pre-wrap;min-height:170px;border-radius:12px;border:1px dashed var(--line);padding:10px;background:#06141a;word-break:break-word;overflow-wrap:anywhere}
  .muted{color:var(--muted);font-size:.92rem}
  .small{font-size:.85rem}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#071b20;padding:6px 10px;border-radius:999px}
  .state{display:flex;gap:8px;flex-wrap:wrap}
  .ok{color:var(--accent-strong)} .warn{color:var(--accent-warn)}
  .dirbtn{display:flex;align-items:center;justify-content:center;gap:8px;font-weight:800;width:auto;min-width:180px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#071b20;border:1px solid #2a2f40;border-bottom-width:2px;border-radius:6px;padding:1px 6px}
  details summary{cursor:pointer}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  a{color:var(--tiktok);text-decoration:none;font-weight:600}
  a:hover{text-decoration:underline}
  /* Listados y admin */
  .list{display:grid;gap:8px;margin-top:8px}
  .item{display:grid;gap:8px;border:1px dashed var(--line);border-radius:12px;padding:10px;background:#06181e}
  .item .row2{display:grid;grid-template-columns:1fr 1fr auto auto;gap:8px;align-items:center}
  .item small{color:var(--muted)}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chipOpt{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#071b20;padding:6px 10px;border-radius:999px}
  /* Sim Chat */
  .simchat-card{background:#071e24;border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:18px}
  .persona-tabs{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px}
  .persona-tabs .tab{padding:8px 14px;border-radius:999px;border:1px solid var(--line);background:#071b20;color:#e6f7f4;font-weight:700;cursor:pointer}
  .persona-tabs .tab.active{background:linear-gradient(180deg,#22d3a6,#10b981);color:#052018;border:none}
  .persona-tabs .tab.lock::after{content:" üîí";opacity:.9}
  .needs-row{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 12px}
  .need-pill{padding:6px 12px;border-radius:999px;border:1px solid var(--line);background:#0a2229;color:#b7e2df;font-weight:700}
  .simchat-grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .simchat-grid .out{min-height:140px;border:1px dashed var(--line);border-radius:12px;background:#06141a;padding:10px;white-space:pre-wrap}
  .simchat-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
</style>
</head>
<body>
  <header>
    <h1>Simlish Translator <span class="pill">ES ‚áÑ SIM ¬∑ Core v3.1</span></h1>
  </header>

  <main class="wrap">
    <!-- ================== TRADUCTOR ================== -->
    <section class="grid">
      <div class="card">
        <div class="row" style="grid-template-columns:1fr auto">
          <label for="in" style="margin:0;align-self:center">Entrada</label>
          <button id="toggleDir" class="btn dirbtn" title="Cambiar direcci√≥n"><span id="dirLabel">ES ‚Üí SIM</span></button>
        </div>
        <textarea id="in" placeholder="Escribe aqu√≠."></textarea>
        <div class="row" style="margin-top:12px">
          <button id="translate" class="btn">Traducir</button>
          <button id="clear" class="btn sec" title="Borrar texto">Limpiar</button>
        </div>
        <p class="muted small">Aprendizaje estricto: se guarda y sincroniza en el backend autom√°ticamente.</p>
        <div class="toolbar">
          <button id="exportBtn" class="btn sec" title="Exportar vocab de usuario">Exportar .JSON</button>
          <button id="viewConflicts" class="btn sec" title="Ver conflictos">Ver conflictos</button>
        </div>
        <div id="strictBanner" class="small muted" style="display:none"></div>
      </div>

      <div class="card">
        <label for="out">Salida</label>
        <div id="out" class="out" aria-live="polite">--</div>
        <div class="row" style="margin-top:12px">
          <button id="copy" class="btn">Copiar</button>
          <button id="demo" class="btn sec" title="Ejemplo r√°pido">Ejemplo</button>
        </div>
        <div class="state" style="margin-top:12px">
          <span class="chip">Modo: <b>Estricto</b></span>
          <span class="chip">Direcci√≥n: <b id="stateDirVal">ES‚ÜíSIM</b></span>
          <span class="chip">Versi√≥n base: <b>3.1</b></span>
          <span class="chip" id="confBadge">Conflictos: <b id="confCount">0</b></span>
          <span class="chip">Lex: <b id="metaLex">-</b></span>
          <span class="chip" id="hostChip" title="Backend">Host: <b id="hostState">‚Ä¶</b></span>
          <span class="chip" data-chip="ml" title="Modelo">ML: <b id="mlState">‚Ä¶</b></span>
        </div>
      </div>
    </section>

    <section class="card">
      <details open>
        <summary><strong>Historial (√∫ltimos 10 aprendidos)</strong></summary>
        <div id="history" class="small muted" style="margin-top:8px">--</div>
      </details>
      <details style="margin-top:12px">
        <summary><strong>Gram√°tica & Vocab cargados</strong></summary>
        <div class="small muted" id="meta"></div>
      </details>
      <p class="muted small" style="margin-top:10px">
        Tiempos: prefijos <span class="kbd">dra-</span>/<span class="kbd">to-</span>, sufijos <span class="kbd">-nu</span>/<span class="kbd">-ru</span> con auxiliar <span class="kbd">shoba</span>.
      </p>
    </section>

    <!-- ================== PANEL ADMIN (discreto, sobre el pie) ================== -->
    <section class="card" id="adminShell">
      <div class="row auto">
        <input id="secretPass" type="password" placeholder="Contrase√±a admin" aria-label="Contrase√±a admin"/>
        <button id="secretUnlock" class="btn" style="width:auto">Desbloquear</button>
      </div>
      <div id="secretPanel" style="display:none;margin-top:12px">
        <!-- Conflictos -->
        <div class="toolbar">
          <button id="btnListConflicts" class="btn sec">Listar conflictos</button>
          <button id="btnGenTravieso" class="btn sec">Generar clave Travieso</button>
          <button id="btnCopyTravieso" class="btn sec">Copiar clave</button>
          <span id="traviesoKeyView" class="small muted"></span>
        </div>

        <!-- Buscador / Editor / Borrado -->
        <div class="chips" style="margin:10px 0 6px">
          <label class="chipOpt"><input type="radio" name="mode" value="ES" checked> ES</label>
          <label class="chipOpt"><input type="radio" name="mode" value="SIM"> SIM</label>
        </div>
        <div class="row">
          <input id="searchQuery" placeholder="buscar‚Ä¶"/>
          <button id="btnSearch" class="btn sec">Buscar</button>
        </div>
        <div id="searchInfo" class="small muted" style="margin-top:6px">Edita/borra solo pares de <b>Usuario</b>. CORE es de solo lectura.</div>
        <div id="results" class="list"></div>

        <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

        <!-- Generador previo a guardar -->
        <div class="row">
          <input id="newEs" placeholder="Espa√±ol"/>
          <input id="newSim" placeholder="(generado aqu√≠)"/>
        </div>
        <div class="row" style="grid-template-columns:auto auto 1fr">
          <button id="btnGen" class="btn sec">Generar</button>
          <button id="btnCreate" class="btn">Guardar</button>
          <span class="small muted"></span>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

        <!-- CONTROLES ML (bloqueados hasta editar) -->
        <div id="mlCtrlWrap">
          <div class="row auto">
            <button id="mlEdit" class="btn sec" style="width:auto">Editar controles ML</button>
            <span class="small muted">Bloqueados hasta que pulses ‚ÄúEditar controles ML‚Äù.</span>
          </div>
          <div id="mlCtrls" style="opacity:.55;pointer-events:none;margin-top:12px">
            <div class="row">
              <label>Temperature <input id="mlTemp" type="range" min="0" max="2" step="0.01"></label>
              <label>Top-K <input id="mlTopK" type="range" min="1" max="100" step="1"></label>
            </div>
            <div class="row">
              <label>Top-P <input id="mlTopP" type="range" min="0" max="1" step="0.01"></label>
              <label>Presence Penalty <input id="mlPP" type="range" min="-2" max="2" step="0.01"></label>
            </div>
            <div class="row">
              <label>Frequency Penalty <input id="mlFP" type="range" min="-2" max="2" step="0.01"></label>
              <div class="toolbar">
                <button class="btn sec" data-preset="safe">Segura</button>
                <button class="btn sec" data-preset="optimo">√ìptimo</button>
                <button class="btn sec" data-preset="creative">Creativa</button>
                <button class="btn sec" data-preset="chaos">Ca√≥tica</button>
              </div>
            </div>
            <div class="toolbar">
              <button id="mlSave" class="btn">Guardar controles</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ================== SIM CHAT ================== -->
    <section id="simchat-v2" class="simchat-card">
      <h2 style="margin:0 0 10px">Sim Chat</h2>

      <div class="persona-tabs" id="personaTabs">
        <button class="tab active"  data-persona="tierno">Tierno</button>
        <button class="tab"          data-persona="sabio">Sabio</button>
        <button class="tab"          data-persona="payasin">Payas√≠n</button>
        <button class="tab lock"     data-persona="travieso" title="Requiere clave">Travieso</button>
      </div>
      <div id="personaNote" class="small muted">Tierno activo.</div>

      <div class="needs-row">
        <span class="need-pill">Hambre</span>
        <span class="need-pill">Diversi√≥n</span>
        <span class="need-pill">Higiene</span>
        <span class="need-pill">Energ√≠a</span>
        <span class="need-pill">Social</span>
        <span class="need-pill">Vejiga</span>
      </div>

      <div class="simchat-grid">
        <textarea id="simchatInput" placeholder="Tu mensaje (ES o SIM)"></textarea>
        <div>
          <label class="small muted">Respuesta (SIM ‚Üî ES)</label>
          <div id="simOutSim" class="out">--</div>
          <div id="simOutEs"  class="out" style="margin-top:8px">--</div>
        </div>
      </div>

      <div class="simchat-actions">
        <button id="simSend"  class="btn">Enviar</button>
        <button id="simClear" class="btn sec">Limpiar chat</button>
      </div>
    </section>

  </main>

  <footer style="text-align:center;padding:16px;font-size:.85rem;color:var(--muted);border-top:1px solid var(--line);margin-top:24px">
    <a href="https://www.tiktok.com/@musimiau?_t=ZM-8stssM0VX78&_r=1" target="_blank">@musimiau en TikToküß°üíú</a>
    <br>
    ‚òÜ Creado por <b style="color:var(--accent)">&nbsp;Musi Dklja&nbsp;</b> (2025)
  </footer>

<script>
/* ===================== CONFIG + KEYS ===================== */
const CORE_VERSION = "3.1";
const STRICT_MODE = true;
const KEY_USER    = `simlishLexiconUser:${CORE_VERSION}`;
const KEY_HISTORY = `simlishLexiconHistory:${CORE_VERSION}`;
const KEY_TRAVIESO= "sim.travieso.key";
const KEY_GENCFG  = "sim.ml.gencfg";
const ADMIN_PASS  = "1908924672";

/* Backend + MML (mismo Render) */
const BACKEND_URL = "https://simlish-translator-backend.onrender.com";
const MML_BASE    = BACKEND_URL + "/mml";

/* ===================== HELPERS ===================== */
const deacc = s => String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");
const normEs  = s => deacc(String(s||"").toLowerCase()).trim();
const normSim = s => String(s||"").toLowerCase().trim();

function defaultUserStore(){ return { es2sim:{}, sim2es:{} }; }
function loadUser(){ try{ return JSON.parse(localStorage.getItem(KEY_USER)||"") || defaultUserStore(); } catch{ return defaultUserStore(); } }
function saveUser(store){ try{ localStorage.setItem(KEY_USER, JSON.stringify(store)); }catch{} dirtySinceLastPush = true; schedulePushToHost(); }
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(KEY_HISTORY)||"[]"); }catch{ return []; } }
function saveHistory(list){ try{ localStorage.setItem(KEY_HISTORY, JSON.stringify(list.slice(-10))); }catch{} dirtySinceLastPush = true; schedulePushToHost(); }

function getTraviesoKey(){ try{ return localStorage.getItem(KEY_TRAVIESO)||""; }catch{ return ""; } }
function setTraviesoKey(k){ try{ localStorage.setItem(KEY_TRAVIESO,k||""); }catch{} }
function getGenCfg(){
  try{ return JSON.parse(localStorage.getItem(KEY_GENCFG)||"") || {temp:0.7, topK:80, topP:0.9, pp:0.0, fp:0.0}; }
  catch{ return {temp:0.7, topK:80, topP:0.9, pp:0.0, fp:0.0}; }
}
function saveGenCfg(cfg){ try{ localStorage.setItem(KEY_GENCFG, JSON.stringify(cfg)); }catch{} }

/* ===================== CORE (resumen) ===================== */
/* Nota: El usuario tiene +5k pares en el backend. Aqu√≠ dejamos el CORE estable. */
const DATA = {
  gramatica:{
    orden:"Sujeto ‚Äì Verbo ‚Äì Objeto (SVO)",
    adjetivo:"Despu√©s del sustantivo",
    posesion:"Con 'ta' ‚Üí Parshu ta meeba = mi pareja",
    negacion:{nah:"no (simple)",nuvva:"nunca / negaci√≥n fuerte"},
    plural:"Usar -s / -as / -us seg√∫n sonoridad",
    comparativos:{moo:"m√°s",minnu:"menos",firbs:"muy"},
    tiempos:{ auxiliar:"shoba = estar/ser", prefijos:{"dra-":"pasado","to-":"futuro"}, sufijos:{"-nu":"presente","-ru":"en curso"} },
    interrogativos:{harva:"qu√©/c√≥mo",kujan:"c√≥mo (coloquial)"},
    adverbios_tiempo:{ nuvra:"ahora", yestu:"ayer", tombru:"ma√±ana" }
  },
  vocabulario:{
    pronombres:{"meeba":"yo","teeba":"t√∫","heeba":"√©l","sheba":"ella","weeba":"nosotros","da":"el / la / los / las"},
    basicos:{
      "sul sul":"hola",
      "su laa":"bienvenidos",
      "dag dag":"chao",
      "da vaa":"adi√≥s",
      "yibu":"s√≠","nah":"no","nuvva":"nunca","felnu":"perd√≥n","firvu":"bien hecho","whazzu":"¬øqu√© pasa?","gratvu":"gracias","prezooba":"bonito / hermoso"
    },
    clima:{"friznu":"fr√≠o","brasha":"caliente","skrashu":"rayo / rel√°mpago"},
    verbos_cotidianos:{"brazu":"cocinar","nomma":"comer","gluppa":"beber","delvu":"servir","klasha":"cortar","mashka":"masticar","travnu":"ir / ir a","gavna":"tener","dropla":"dejar caer","workru":"trabajar","zurnu":"ganas / √°nimo","showru":"aparecer / mostrar(se)"},
    animales:{"chirva":"ave / p√°jaro"}
  },
  phrasebook:{
    saludos:{
      "Su laa!":"¬°Bienvenidos!",
      "Sul sul!":"¬°Hola!",
      "Dag dag!":"¬°Chao!",
      "Da vaa.":"Adi√≥s."
    }
  }
};

/* ===================== √çNDICES ===================== */
let CORE_ES2SIM=new Map(), CORE_SIM2ES=new Map(), PH_ES2SIM=new Map(), PH_SIM2ES=new Map();
(function buildCore(){
  for(const entries of Object.values(DATA.vocabulario)){
    for(const [sim, es] of Object.entries(entries)){
      const espNorm = normEs(es), simNorm = normSim(sim);
      const variants = espNorm.split(/[\/ ,]/).map(s=>s.trim()).filter(Boolean);
      for(const v of variants){ if(!CORE_ES2SIM.has(v)) CORE_ES2SIM.set(v, sim); }
      if(!CORE_SIM2ES.has(simNorm)) CORE_SIM2ES.set(simNorm, es.split('/')[0]);
    }
  }
  for(const group of Object.values(DATA.phrasebook||{})){
    for(const [sim, es] of Object.entries(group)){
      PH_ES2SIM.set(normEs(es), sim);
      PH_SIM2ES.set(normSim(sim), es);
    }
  }
})();

/* ===================== ESTADO ===================== */
const DIR={ ES2SIM:"ES2SIM", SIM2ES:"SIM2ES" };
let CURRENT_DIR=DIR.ES2SIM, lastLearnedCount=0;
let USER = loadUser();
let HISTORY = loadHistory();
let pushTimer=null, pulling=false, dirtySinceLastPush=false;

/* ===================== UTILIDADES ===================== */
function tokensOf(text){ return text.match(/[\w√°√©√≠√≥√∫√±√º_]+|[.,;:!?]/gi) || [text]; }
function preserveCase(o,r){ return /^[A-Z√Å√â√ç√ì√ö√ë√ú]/.test(o) ? r.charAt(0).toUpperCase()+r.slice(1) : r; }
function currentSimOwner(sim){ const k=normSim(sim); if(USER.sim2es[k]) return {scope:"USER", es:USER.sim2es[k]}; if(CORE_SIM2ES.has(k)) return {scope:"CORE", es:CORE_SIM2ES.get(k)}; return null; }
function ensureUniqueSim(sim, es){
  let base=normSim(sim); const owner=currentSimOwner(base);
  if(!owner || normEs(owner.es)===normEs(es)) return sim;
  const suff=["ah","eh","oh","nu","ru","va","la","ra","ba"]; for(const s of suff){ const c=base+s; if(!currentSimOwner(c)) return preserveCase(sim,c); }
  let i=2; while(currentSimOwner(base+i)) i++; return preserveCase(sim, base+i);
}
function scanConflicts(){
  const seen=new Map(), conflicts=[];
  function addMap(obj){ for(const [es,sim] of Object.entries(obj)){ const s=normSim(sim), e=normEs(es); if(!seen.has(s)) seen.set(s,e); else if(seen.get(s)!==e) conflicts.push({sim:s,a:seen.get(s),b:e}); } }
  for(const entries of Object.values(DATA.vocabulario)){ for(const [sim,es] of Object.entries(entries)) addMap({[es]:sim}); }
  addMap(USER.es2sim||{}); return conflicts;
}

/* ===== multi-palabras simlish (su laa / dag dag / da vaa / sul sul) ===== */
function getMultiSimKeys(){
  const keys = new Set();
  for (const entries of Object.values(DATA.vocabulario||{})){
    for (const sim of Object.keys(entries||{})) if (sim.includes(" ")) keys.add(sim.toLowerCase());
  }
  for (const sim of Object.keys(USER.sim2es||{})) if (sim.includes(" ")) keys.add(sim.toLowerCase());
  return Array.from(keys).sort((a,b)=> b.length - a.length);
}
function compressMultiSim(text){
  let out=text; for(const key of getMultiSimKeys()){
    const esc = key.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    out = out.replace(new RegExp(`\\b${esc}\\b`,"gi"), m => m.replace(/\s+/g,"_"));
  } return out;
}
function expandMultiSim(tok){ return tok.replace(/_/g," "); }

/* ===================== TIEMPOS + GENERADOR ===================== */
const adv = DATA.gramatica?.adverbios_tiempo || {};
const PAST_LEX=new RegExp("\\b("+["ayer","antes","ya",adv.yestu,"anoche"].filter(Boolean).join("|")+")\\b","i");
const FUT_LEX=new RegExp("\\b("+["ma√±ana","manana","luego","despu√©s","despues","pronto",adv.tombru,"pasado ma√±ana"].filter(Boolean).join("|")+")\\b","i");
const PRES_LEX=new RegExp("\\b("+["hoy","ahora","enseguida",adv.nuvra].filter(Boolean).join("|")+")\\b","i");
const RE={ ira:/\b(voy|vas|va|vamos|van)\s+a\s+[a-z√°√©√≠√≥√∫√±√º]+(ar|er|ir)\b/i, fut:/\b[a-z√°√©√≠√≥√∫√±√º]+(r√©|r√°s|r√°|remos|r√°n)\b/i,
  pret:/\b[a-z√°√©√≠√≥√∫√±√º]+(√©|aste|√≥|amos|aron|√≠|iste|i√≥|imos|ieron)\b/i, imp:/\b[a-z√°√©√≠√≥√∫√±√º]+(aba|abas|√°bamos|aban|√≠a|√≠as|√≠amos|√≠an)\b/i,
  pastIrreg:/\b(fui|fue|fuiste|fuimos|fueron|estuve|estuviste|estuvo|estuvimos|estuvieron|era|eras|√©ramos|eran|estaba|estabas|est√°bamos|estaban)\b/i,
  prog:/\b(estoy|estas|est√°|estamos|est√°n|est√°s)\s+[a-z√°√©√≠√≥√∫√±√º]+(ando|iendo|yendo)\b/i };
const TENSE={ PAST:"past", PRESENT:"present", FUTURE:"future", PROG:"progressive" };
function detectTense(es){ if(RE.prog.test(es))return TENSE.PROG; if(FUT_LEX.test(es)||RE.ira.test(es)||RE.fut.test(es))return TENSE.FUTURE; if(PAST_LEX.test(es)||RE.pret.test(es)||RE.imp.test(es)||RE.pastIrreg.test(es))return TENSE.PAST; if(PRES_LEX.test(es))return TENSE.PRESENT; return TENSE.PRESENT; }
function xorshift32(seed){ let x=seed|0; return ()=> (x^=x<<13,x^=x>>>17,x^=x<<5,(x>>>0)/4294967296); }
function hashStr(s){ let h=2166136261>>>0; for(const c of s) h=Math.imul(h ^ c.charCodeAt(0),16777619); return h>>>0; }
const SYLL=["su","la","noo","boo","zim","zam","sha","bah","voh","plar","gib","yib","flo","fru","doo","ka","ru","shi","ku","va","na","mo","ta","re","lo"];
function synth(word){ const w=normEs(word).replace(/[^a-z0-9\s]/g,""); if(!w) return word; const rnd=xorshift32(hashStr(w)); let n=Math.max(2,Math.min(4,Math.ceil(w.length/4))); let out=[]; for(let i=0;i<n;i++) out.push(SYLL[Math.floor(rnd()*SYLL.length)]); let res=out.join(""); if(/r$/.test(w)) res+="ru"; if(/n$/.test(w)) res+="nu"; return ensureUniqueSim(res, word); }

/* ===================== APRENDER ===================== */
function learnPairs(pairs){
  let learned=0, stamped=[];
  for (const [esRaw, simRaw] of pairs){
    const es=String(esRaw||"").trim();
    const sim1=String(simRaw||"").trim();
    if(!es) continue;
    const sim=ensureUniqueSim(sim1 || synth(es), es);
    const kEs=normEs(es), kSim=normSim(sim);
    if(!kSim) continue;

    const prevSim=USER.es2sim[kEs]; if(prevSim && normSim(prevSim)!==kSim){ delete USER.sim2es[normSim(prevSim)]; }
    const prevEs=USER.sim2es[kSim]; if(prevEs && normEs(prevEs)!==kEs){ delete USER.es2sim[normEs(prevEs)]; }

    if(!USER.es2sim[kEs]){ USER.es2sim[kEs]=sim; learned++; }
    if(!USER.sim2es[kSim]){ USER.sim2es[kSim]=es; }
    stamped.push({es, sim, t:new Date().toISOString()});
  }
  if(stamped.length){ HISTORY=[...HISTORY, ...stamped].slice(-10); saveHistory(HISTORY); }
  if(learned>0) saveUser(USER);
  return learned;
}

/* ===================== TRADUCCI√ìN ===================== */
function translateES2SIM(text){
  const sentences=text.match(/[^.!?]+[.!?]?/g) || [text]; let newPairs=[];
  const out=sentences.map(raw=>{
    const s=raw.trim(); if(!s) return "";

    const pb = PH_ES2SIM.get(normEs(s.replace(/[.!?]$/,""))); if(pb) return pb;

    const hasNever=/\bnunca\b/i.test(s), hasNo=/\bno\b/i.test(s); const NEG=hasNever?"nuvva":(hasNo?"nah":"");
    const tense=detectTense(s); const toks=tokensOf(s); const simToks=[]; let injected=false;
    for(const t of toks){
      if(/^[.,;:!?]$/.test(t)){ simToks.push(t); continue; }
      const key=normEs(t); let sim=USER.es2sim[key] || CORE_ES2SIM.get(key);
      if(!sim){ sim=synth(t); newPairs.push([key, sim]); } else { sim=ensureUniqueSim(sim, t); }
      const isVerb=["brazu","nomma","gluppa","delvu","klasha","mashka","travnu","gavna","dropla","workru","zurnu","showru"].includes(normSim(sim));
      if(!injected && isVerb){
        let pref="", suf="", aux="shoba";
        if(tense===TENSE.PAST) pref="dra-"; else if(tense===TENSE.FUTURE) pref="to-"; else if(tense===TENSE.PRESENT) suf="-nu"; else if(tense===TENSE.PROG) suf="-ru";
        let phrase=`${aux} ${pref}${sim}${suf}`; if(NEG) phrase=`${NEG} ${phrase}`;
        simToks.push(phrase); injected=true;
      }else{
        if(/^no$|^nunca$/i.test(t)) continue;
        simToks.push(sim);
      }
    }
    let outS=simToks.join(" ").replace(/\s+([.,;:!?])/g,"$1").replace(/\s+/g," ").trim();
    if(outS) outS=outS.charAt(0).toUpperCase()+outS.slice(1); return outS;
  }).join(" ");
  const learnedFromGen=learnPairs(newPairs);
  return { text: out, learnedFromGen };
}

function translateSIM2ES(text){
  const sentences = text.match(/[^.!?]+[.!?]?/g) || [text];
  const out = sentences.map(raw=>{
    const s = raw.trim(); if(!s) return "";

    const pb = PH_SIM2ES.get(normSim(s.replace(/[.!?]$/,""))); if(pb) return pb;

    const pre = compressMultiSim(s);
    const toks = tokensOf(pre);
    const esToks = [];

    for(const t0 of toks){
      if(/^[.,;:!?]$/.test(t0)){ esToks.push(t0); continue; }
      const t = expandMultiSim(t0);
      const key = normSim(t);

      let es = USER.sim2es[key] || CORE_SIM2ES.get(key);
      if(!es){
        const base = key.replace(/^(dra-|to-)/,"").replace(/(-nu|-ru)$/,"");
        es = USER.sim2es[base] || CORE_SIM2ES.get(base);
      }
      if(!es){ es = t; }
      esToks.push(es);
    }

    let outS = esToks.join(" ").replace(/\s+([.,;:!?])/g,"$1").replace(/\s+/g," ").trim();
    if(outS) outS = outS.charAt(0).toUpperCase() + outS.slice(1);
    return outS;
  }).join(" ");
  return { text: out };
}

/* ===================== UI refs ===================== */
const $in=document.getElementById("in"), $out=document.getElementById("out");
const $btn=document.getElementById("translate"), $clear=document.getElementById("clear");
const $copy=document.getElementById("copy"), $demo=document.getElementById("demo");
const $toggleDir=document.getElementById("toggleDir"), $dirLabel=document.getElementById("dirLabel");
const $meta=document.getElementById("meta"), $metaLex=document.getElementById("metaLex");
const $history=document.getElementById("history"), $exportBtn=document.getElementById("exportBtn");
const $confBadge=document.getElementById("confBadge"), $confCount=document.getElementById("confCount");
const $hostChip=document.getElementById("hostChip"), $hostState=document.getElementById("hostState");
const $mlState=document.getElementById("mlState");
const $viewConflicts=document.getElementById("viewConflicts");

/* ===================== UI helpers ===================== */
function setDir(d){ CURRENT_DIR=d; const lbl=d===DIR.ES2SIM?"ES ‚Üí SIM":"SIM ‚Üí ES"; $dirLabel.textContent=lbl; document.getElementById("stateDirVal").textContent=lbl.replace(" ",""); }
$toggleDir.addEventListener("click", ()=> setDir(CURRENT_DIR===DIR.ES2SIM?DIR.SIM2ES:DIR.ES2SIM));

$btn.addEventListener("click", doTranslate);
$clear.addEventListener("click", ()=>{ $in.value=""; $out.textContent="--"; lastLearnedCount=0; refreshMeta(); });
$copy.addEventListener("click", async ()=>{ const txt=$out.textContent.trim(); if(!txt||txt==="--"){ alert("No hay texto para copiar."); return; } try{ await navigator.clipboard.writeText(txt); $copy.textContent="¬°Copiado!"; setTimeout(()=>{$copy.textContent="Copiar";},900); }
catch{ const ta=document.createElement("textarea"); ta.value=txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand("copy"); $copy.textContent="¬°Copiado!"; } finally{ document.body.removeChild(ta); setTimeout(()=>{$copy.textContent="Copiar";},900); } } });
$demo.addEventListener("click", ()=>{ if(CURRENT_DIR===DIR.ES2SIM){ $in.value="Ayer cocin√© sopa caliente, hoy la estoy sirviendo y ma√±ana la voy a compartir."; } else { $in.value="Sul sul, meeba shoba dra-brazu supa brasha. Delvu da supa wit spuvu."; } doTranslate(); });
$exportBtn.addEventListener("click", ()=>{ const data=localStorage.getItem(KEY_USER) || "{}"; const blob=new Blob([data], {type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`simlish-vocab-user-v${CORE_VERSION}.json`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); });
$viewConflicts.addEventListener("click", ()=>{ const confs=scanConflicts(); if(!confs.length){ alert("Sin conflictos."); return; } alert(confs.map(c=>`SIM: ${c.sim}\n‚Üí A: ${c.a}\n‚Üí B: ${c.b}`).join("\n\n")); });

function refreshMeta(){
  const cats=Object.keys(DATA.vocabulario||{}); let totalCore=0; for(const c of cats) totalCore+=Object.keys(DATA.vocabulario[c]).length;
  const userES=Object.keys(USER.es2sim||{}).length, userSIM=Object.keys(USER.sim2es||{}).length;
  if($meta)    $meta.textContent    = `Categor√≠as: ${cats.length} ¬∑ Entradas base: ${totalCore} ¬∑ Usuario: ${userES}/${userSIM} (ES/SIM).`;
  if($metaLex) $metaLex.textContent = `${totalCore} + ${userES}‚Üë`;

  if($history){
    const hist=(Array.isArray(HISTORY)?HISTORY:[]).slice(-10);
    $history.innerHTML = hist.length ? hist.map(h=>`‚Ä¢ <b>${h.es}</b> ‚Üî <i>${h.sim}</i> <span class="muted">(${new Date(h.t||Date.now()).toLocaleString()})</span>`).join("<br>") : "--";
  }
  const confs=scanConflicts(); $confCount.textContent=String(confs.length);
  $confBadge.classList.toggle("warn", confs.length>0); $confBadge.classList.toggle("ok", confs.length===0);
  updateHostIndicators(); pingML();
}

/* ===================== SYNC BACKEND ===================== */
function endpoint(){ return BACKEND_URL; }
function schedulePushToHost(){ clearTimeout(pushTimer); pushTimer=setTimeout(pushToHost, 600); }
async function pushToHost(){
  try{
    const payload={ core_version: CORE_VERSION, t:new Date().toISOString(), user:USER, history:HISTORY };
    const r=await fetch(endpoint(),{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(payload), mode:"cors", credentials:"omit" });
    if(!r.ok) throw new Error(r.status);
    dirtySinceLastPush=false;
  }catch(e){}
  updateHostIndicators();
}
async function pullFromHost(){
  if(pulling) return; pulling=true;
  try{
    const r=await fetch(endpoint(),{method:"GET",mode:"cors",credentials:"omit"});
    if(!r.ok) throw new Error(r.status);
    const data=await r.json();
    if(data && data.user){
      USER=USER||defaultUserStore();
      USER.es2sim=Object.assign({}, USER.es2sim||{}, data.user.es2sim||{});
      USER.sim2es=Object.assign({}, USER.sim2es||{}, data.user.sim2es||{});
      saveUser(USER);
      if(Array.isArray(data.history)){ HISTORY=data.history.slice(-10); saveHistory(HISTORY); }
    }
  }catch(e){}
  finally{ pulling=false; updateHostIndicators(); refreshMeta(); }
}
function flushViaBeacon(){ if(!dirtySinceLastPush) return;
  try{ const payload=JSON.stringify({ core_version: CORE_VERSION, t:new Date().toISOString(), user:USER, history:HISTORY, flush:true });
    const blob=new Blob([payload],{type:"application/json"}); navigator.sendBeacon(endpoint(), blob); dirtySinceLastPush=false;
  }catch(_){}
}
window.addEventListener("pagehide", flushViaBeacon);
document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==="hidden") flushViaBeacon(); });
window.addEventListener("beforeunload", flushViaBeacon);

function updateHostIndicators(){
  const setTag = (tag, ok) => { $hostState.textContent = tag; $hostChip.classList.toggle("ok", ok===true); $hostChip.classList.toggle("warn", ok===false); };
  fetch(BACKEND_URL, { method:"GET", mode:"cors", cache:"no-store" })
    .then(r => r.ok ? r.json().then(()=>setTag("OK",true)) : setTag("Sin respuesta",false))
    .catch(()=> setTag("Sin respuesta",false));
}

/* ===================== TRADUCIR ===================== */
function doTranslate(){
  lastLearnedCount=0;
  const inputRaw=($in.value||"").trim();
  if(!inputRaw){ $out.textContent="--"; refreshMeta(); return; }

  let resultText="";
  if(CURRENT_DIR===DIR.ES2SIM){
    const res=translateES2SIM(inputRaw);
    resultText=res.text; lastLearnedCount=res.learnedFromGen||0;
  }else{
    const res=translateSIM2ES(inputRaw);
    resultText=res.text;
  }
  $out.textContent=(resultText||"--");
  refreshMeta();
}

/* ===================== ADMIN ===================== */
document.getElementById("secretUnlock").addEventListener("click", ()=>{
  const pass=(document.getElementById("secretPass").value||"").trim();
  if(pass===ADMIN_PASS){ document.getElementById("secretPanel").style.display="block"; document.getElementById("secretPass").value=""; injectMLControls(); refreshTraviesoKeyView(); }
  else{ alert("Contrase√±a incorrecta."); }
});

function resultsFromQuery(q, mode){
  q=(q||"").trim().toLowerCase(); const items=[]; if(!q) return items;
  if(mode==="ES"){
    for(const [es,sim] of Object.entries(USER.es2sim||{})){ if(es.includes(q)) items.push({scope:"USER", es, sim}); }
    for(const [key, sim] of CORE_ES2SIM.entries()){ if(key.includes(q)){ const es=key; if(!(USER.es2sim && USER.es2sim[es])) items.push({scope:"CORE", es, sim}); } }
  }else{
    for(const [simKey, es] of Object.entries(USER.sim2es||{})){ if(simKey.includes(q)) items.push({scope:"USER", es, sim:simKey}); }
    for(const [simKey, es] of CORE_SIM2ES.entries()){ if(simKey.includes(q)){ if(!(USER.sim2es && USER.sim2es[simKey])) items.push({scope:"CORE", es, sim:simKey}); } }
  }
  return items.slice(0,200);
}
function renderResults(list){
  const $results=document.getElementById("results"); if(!$results) return; $results.innerHTML="";
  if(!list||!list.length){ $results.innerHTML=`<div class="small muted">Sin resultados.</div>`; return; }
  for(const item of list){
    const div=document.createElement("div"); div.className="item";
    const isCore=item.scope==="CORE"; const locked=isCore ? true : false;
    const esId="es_"+Math.random().toString(36).slice(2), simId="sim_"+Math.random().toString(36).slice(2);
    div.innerHTML=`<div class="row2">
        <input id="${esId}" value="${item.es}" ${isCore?'disabled':''} title="${isCore?'CORE (solo lectura)':'Espa√±ol'}"/>
        <input id="${simId}" value="${item.sim}" ${locked?'disabled':''} title="${locked?'Bloqueado':'Simlish'}"/>
        <button class="btn" ${locked?'disabled':''} data-action="save">Guardar</button>
        <button class="btn danger" ${locked?'disabled':''} data-action="del">Borrar</button>
      </div>
      <small>${isCore? 'CORE ¬∑ No editable. Crea sobreescritura en Usuario si quieres cambiarlo.' : 'Usuario ¬∑ Editable/Borrable'}</small>`;
    div.querySelector('[data-action="save"]')?.addEventListener('click', ()=>{
      const esVal=document.getElementById(esId).value.trim(); let simVal=document.getElementById(simId).value.trim();
      if(!esVal){ alert("Falta Espa√±ol."); return; } if(!simVal){ simVal=synth(esVal); }
      simVal=ensureUniqueSim(simVal, esVal);
      const kEs=normEs(esVal), kSim=normSim(simVal);
      const prevSim=USER.es2sim[kEs]; if(prevSim && prevSim!==simVal){ delete USER.sim2es[normSim(prevSim)]; }
      const prevEs=USER.sim2es[kSim]; if(prevEs && prevEs!==esVal){ delete USER.es2sim[normEs(prevEs)]; }
      USER.es2sim[kEs]=simVal; USER.sim2es[kSim]=esVal;
      HISTORY=[...HISTORY,{es:esVal,sim:simVal,t:new Date().toISOString()}].slice(-10);
      saveUser(USER); saveHistory(HISTORY); renderResults([{scope:"USER", es:esVal, sim:simVal}]); refreshMeta();
    });
    div.querySelector('[data-action="del"]')?.addEventListener('click', ()=>{
      const esVal=document.getElementById(esId).value.trim(); const simVal=document.getElementById(simId).value.trim();
      if(!confirm(`¬øBorrar par USUARIO?\n${esVal} ‚Üî ${simVal}`)) return;
      delete USER.es2sim[normEs(esVal)];
      delete USER.sim2es[normSim(simVal)];
      saveUser(USER); renderResults([]); refreshMeta();
    });
    $results.appendChild(div);
  }
}
document.getElementById("btnSearch").addEventListener("click", ()=>{
  const q=(document.getElementById("searchQuery")?.value)||"";
  const mode=Array.from(document.querySelectorAll('input[name="mode"]')||[]).find(r=>r.checked)?.value || "ES";
  renderResults(resultsFromQuery(q, mode));
});
document.getElementById("btnGen").addEventListener("click", ()=>{
  const es=(document.getElementById("newEs")?.value||"").trim(); if(!es){ alert("Escribe Espa√±ol."); return; }
  document.getElementById("newSim").value = ensureUniqueSim(synth(es), es);
});
document.getElementById("btnCreate").addEventListener("click", ()=>{
  const $newEs=document.getElementById("newEs"); const $newSim=document.getElementById("newSim");
  if(!$newEs||!$newSim){ return; }
  const es=($newEs.value||"").trim(); let sim=($newSim.value||"").trim();
  if(!es){ alert("Debes escribir la palabra en Espa√±ol."); return; }
  if(!sim){ sim=ensureUniqueSim(synth(es), es); }
  const kEs=normEs(es), kSim=normSim(sim);
  const prevSim=USER.es2sim[kEs]; if(prevSim && prevSim!==sim){ delete USER.sim2es[normSim(prevSim)]; }
  const prevEs=USER.sim2es[kSim]; if(prevEs && prevEs!==es){ delete USER.es2sim[normEs(prevEs)]; }
  USER.es2sim[kEs]=sim; USER.sim2es[kSim]=es;
  HISTORY=[...HISTORY,{es,sim,t:new Date().toISOString()}].slice(-10);
  saveUser(USER); saveHistory(HISTORY);
  $newEs.value=""; $newSim.value="";
  renderResults([{scope:"USER", es, sim}]); refreshMeta();
});
document.getElementById("btnListConflicts").addEventListener("click", ()=>{
  const confs=scanConflicts(); if(!confs.length){ alert("Sin conflictos."); return; }
  alert(confs.map(c=>`SIM: ${c.sim}\n‚Üí A: ${c.a}\n‚Üí B: ${c.b}`).join("\n\n"));
});

/* Travieso key en admin */
function synthSimlishPhrase(){
  const s=["su","la","noo","boo","zim","zam","sha","bah","voh","plar","gib","yib","flo","fru","doo","ka","ru","shi","ku","va","na","mo","ta","re","lo"];
  const w=()=> s[Math.floor(Math.random()*s.length)]+s[Math.floor(Math.random()*s.length)];
  const tails=["!"," miau!"," hee!"," woo!"," üòâ"]; return `${w()} ${w()}${tails[Math.floor(Math.random()*tails.length)]}`;
}
function refreshTraviesoKeyView(){ const k=getTraviesoKey(); const v=document.getElementById("traviesoKeyView"); if(v) v.textContent = k?(`Clave actual: "${k}"`):"(sin clave)"; }
document.getElementById("btnGenTravieso").addEventListener("click", ()=>{ setTraviesoKey(synthSimlishPhrase()); refreshTraviesoKeyView(); });
document.getElementById("btnCopyTravieso").addEventListener("click", async ()=>{
  const k=getTraviesoKey(); if(!k){ alert("A√∫n no hay clave. Pulsa ‚ÄúGenerar clave Travieso‚Äù."); return; }
  try{ await navigator.clipboard.writeText(k); }catch{ alert(k); }
});

/* ===================== ML CONTROLS (lock/unlock) ===================== */
function applyPreset(name){
  const cfg = getGenCfg();
  if(name==="safe"){ cfg.temp=0.3; cfg.topK=40; cfg.topP=0.8; cfg.pp=0.0; cfg.fp=0.0; }
  else if(name==="optimo"){ cfg.temp=0.7; cfg.topK=90; cfg.topP=0.9; cfg.pp=0.1; cfg.fp=0.0; }
  else if(name==="creative"){ cfg.temp=1.0; cfg.topK=50; cfg.topP=0.95; cfg.pp=0.2; cfg.fp=0.1; }
  else if(name==="chaos"){ cfg.temp=1.4; cfg.topK=20; cfg.topP=1.0; cfg.pp=0.3; cfg.fp=0.2; }
  saveGenCfg(cfg); paintCtrls(cfg);
}
function paintCtrls(cfg){
  document.getElementById("mlTemp").value = cfg.temp;
  document.getElementById("mlTopK").value = cfg.topK;
  document.getElementById("mlTopP").value = cfg.topP;
  document.getElementById("mlPP").value   = cfg.pp;
  document.getElementById("mlFP").value   = cfg.fp;
}
function readCtrls(){
  return {
    temp: parseFloat(document.getElementById("mlTemp").value),
    topK: parseInt(document.getElementById("mlTopK").value,10),
    topP: parseFloat(document.getElementById("mlTopP").value),
    pp:   parseFloat(document.getElementById("mlPP").value),
    fp:   parseFloat(document.getElementById("mlFP").value)
  };
}
function injectMLControls(){
  const wrap=document.getElementById("mlCtrls");
  const cfg=getGenCfg(); paintCtrls(cfg);
  wrap.querySelectorAll("[data-preset]").forEach(b=> b.addEventListener("click", ()=> applyPreset(b.dataset.preset)));
  document.getElementById("mlEdit").onclick = ()=>{
    const pass=prompt("Contrase√±a admin:","");
    if(pass===ADMIN_PASS){
      wrap.style.opacity="1"; wrap.style.pointerEvents="auto";
    }else{ alert("Contrase√±a incorrecta."); }
  };
  document.getElementById("mlSave").onclick = ()=>{
    saveGenCfg(readCtrls());
    wrap.style.opacity=".55"; wrap.style.pointerEvents="none";
    alert("Controles ML guardados.");
  };
}

/* ===================== SIM CHAT ===================== */
(function(){
  const $tabs  = document.getElementById("personaTabs");
  const $note  = document.getElementById("personaNote");
  const $inC   = document.getElementById("simchatInput");
  const $send  = document.getElementById("simSend");
  const $clear = document.getElementById("simClear");
  const $outS  = document.getElementById("simOutSim");
  const $outE  = document.getElementById("simOutEs");

  window.simNeeds = window.simNeeds || { hambre:70, diversion:60, higiene:80, energia:75, social:50, vejiga:60 };

  function setActivePersona(name){
    document.querySelectorAll("#personaTabs .tab").forEach(b=>{
      b.classList.toggle("active", b.dataset.persona===name);
    });
    $note.textContent =
      (name==="travieso") ? "Travieso activo." :
      (name==="payasin")  ? "Payas√≠n activo." :
      (name==="sabio")    ? "Sabio activo." :
                            "Tierno activo.";
  }
  function activePersona(){
    const a = document.querySelector("#personaTabs .tab.active");
    return a ? a.dataset.persona : "tierno";
  }

  $tabs.addEventListener("click", (ev)=>{
    const btn = ev.target.closest(".tab"); if(!btn) return;
    const who = btn.dataset.persona;
    if(who==="travieso"){
      const key = getTraviesoKey();
      if(!key){ alert("Travieso est√° bloqueado. Ve al panel Admin y pulsa ‚ÄúGenerar clave Travieso‚Äù."); return; }
      const typed = prompt("Clave Travieso (frase simlish):","");
      if(!typed || typed.trim()!==key.trim()){ alert("Clave incorrecta."); return; }
    }
    setActivePersona(who);
  });

  async function pingML(){
    try{ const r=await fetch(MML_BASE+"/ping",{cache:"no-store"}); const ok=r.ok; document.getElementById("mlState").textContent = ok? "OK":"Sin ML"; return ok; }
    catch{ document.getElementById("mlState").textContent="Sin ML"; return false; }
  }

  async function sendMsg(){
    const text = ($inC.value||"").trim(); if(!text) return;
    $outS.textContent="..."; $outE.textContent="...";
    try{
      await pingML();
      const cfg = getGenCfg();
      const r = await fetch(MML_BASE+"/chat",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text, persona: activePersona(), needs: window.simNeeds, gen: cfg })
      });
      const data = await r.json();
      $outS.textContent = data.simlish || "(sin simlish)";
      $outE.textContent = data.spanish || "(sin espa√±ol)";
    }catch(e){ $outE.textContent="(Error hablando con el ML)"; }
  }

  $send.addEventListener("click", sendMsg);
  $inC.addEventListener("keydown",(e)=>{ if(e.key==="Enter" && (e.ctrlKey||e.metaKey)){ e.preventDefault(); sendMsg(); }});
  $clear.addEventListener("click", ()=>{ $inC.value=""; $outS.textContent="--"; $outE.textContent="--"; });

  setActivePersona("tierno");
  pingML();
})();

/* ===================== INIT ===================== */
function init(){ setDir(DIR.ES2SIM); pullFromHost(); refreshMeta(); }
init();
</script>
</body>
</html>
