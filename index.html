<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Simlish Translator ¬∑ ES ‚áÑ SIM ¬∑ Core v3.1 (ML-ready)</title>
<meta name="description" content="Traductor bidireccional Espa√±ol ‚áÑ Simlish con aprendizaje, admin, SimChat y respaldo.">
<style>
  :root{ --bg:#06141a; --bg2:#071e24; --ink:#e6f7f4; --muted:#93c5c9; --line:#0f2e35;
         --accent:#22d3a6; --accent-strong:#10b981; --accent-warn:#eab308; --danger:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;background:#06141a;color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:16px 20px;border-bottom:1px solid var(--line);background:#071e24cc;backdrop-filter:blur(6px)}
  h1{margin:0;font-size:1.2rem}
  .wrap{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:950px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--bg2);border:1px solid var(--line);border-radius:12px;padding:14px}
  label{display:block;margin-bottom:6px}
  textarea,input,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#071b20;color:var(--ink)}
  textarea{min-height:140px}
  .btn{cursor:pointer;background:linear-gradient(180deg,var(--accent) 0%,var(--accent-strong) 100%);border:none;font-weight:800}
  .btn.sec{background:#071b20;border:1px solid var(--line);font-weight:600}
  .btn.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);color:#fff}
  .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  .row3{display:grid;gap:10px;grid-template-columns:1fr 1fr auto}
  .out{min-height:140px;border:1px dashed var(--line);padding:10px;background:#06141a;white-space:pre-wrap}
  .state{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#071b20;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
  .link{color:#38bdf8;text-decoration:none}
  .muted{color:var(--muted)} .small{font-size:.9rem}
  /* Admin */
  .secret{max-width:1100px;margin:0 auto;padding:0 20px 12px}
  .list{display:grid;gap:8px;margin-top:8px}
  .item{display:grid;gap:8px;border:1px dashed var(--line);border-radius:10px;padding:10px;background:#06181e}
  /* Popup */
  #backupPopup{position:fixed;inset:0;display:none;place-items:center;background:#0008;z-index:1000}
  #backupPopup .card{max-width:420px;text-align:center}
  /* Sim Chat */
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chipbtn{padding:6px 12px;border-radius:999px;background:#071b20;border:1px solid var(--line);cursor:pointer}
  .chipbtn.active{background:var(--accent);color:#041817;font-weight:800}
  #needs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .need{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#071b20}
  .g0{background:#3a0910} .g1{background:#4a0f12}
  .g2{background:#5a1a14} .g3{background:#6a2616}
  .g4{background:#7a3218} .g5{background:#5b5320}
  .g6{background:#305a20} .g7{background:#23652b}
  .g8{background:#1b7a3b} .g9{background:#109955}
</style>
</head>
<body>
<header><h1>Simlish Translator ¬∑ ES ‚áÑ SIM ¬∑ Core v3.1 (ML-ready)</h1></header>

<main class="wrap">
  <section class="grid">
    <div class="card">
      <div class="row" style="grid-template-columns:1fr auto">
        <label for="in">Entrada</label>
        <button id="toggleDir" class="btn sec"><span id="dirLabel">ES ‚Üí SIM</span></button>
      </div>
      <textarea id="in" placeholder="Escribe aqu√≠..."></textarea>
      <div class="row" style="margin-top:10px">
        <button id="translate" class="btn">Traducir</button>
        <button id="clear" class="btn sec">Limpiar</button>
      </div>
      <p class="small muted">Aprendizaje estricto: se guarda y sincroniza en el backend autom√°ticamente.</p>
      <div class="state">
        <span class="chip">Direcci√≥n: <b id="stateDirVal">ES‚ÜíSIM</b></span>
        <span class="chip">Aprendidos (√∫lt. op.): <b id="stateLearnVal">0</b></span>
        <span class="chip">Conflictos: <b id="confCount">0</b></span>
        <span class="chip">Host: <b id="hostState">--</b></span>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnExport" class="btn sec">Exportar .JSON</button>
        <button id="btnConflicts" class="btn sec">Ver conflictos</button>
      </div>
    </div>

    <div class="card">
      <label for="out">Salida</label>
      <div id="out" class="out">--</div>
      <div class="row" style="margin-top:10px">
        <button id="copy" class="btn">Copiar</button>
        <button id="demo" class="btn sec">Ejemplo</button>
      </div>
      <details style="margin-top:10px">
        <summary><b>Historial (√∫ltimos 10 aprendidos)</b></summary>
        <div id="history" class="small muted" style="margin-top:6px">--</div>
      </details>
      <details style="margin-top:10px">
        <summary><b>Gram√°tica & Vocab cargados</b></summary>
        <div class="small muted" id="meta"></div>
      </details>
    </div>
  </section>

  <!-- Sim Chat -->
  <section class="card">
    <h2>Sim Chat</h2>
    <div class="chips">
      <div class="chipbtn active" data-pers="clasico">Cl√°sico</div>
      <div class="chipbtn" data-pers="tierno">Tierno</div>
      <div class="chipbtn" data-pers="sabio">Sabio</div>
      <div class="chipbtn" data-pers="payasin">Payas√≠n</div>
      <div class="chipbtn" data-pers="travieso">Travieso üîí</div>
    </div>
    <div id="needs">
      <div id="needH" class="need g6">Hambre</div>
      <div id="needD" class="need g6">Diversi√≥n</div>
      <div id="needI" class="need g6">Higiene</div>
      <div id="needE" class="need g6">Energ√≠a</div>
      <div id="needS" class="need g6">Social</div>
      <div id="needV" class="need g6">Vejiga</div>
    </div>
    <textarea id="simIn" placeholder="Habla con tu Sim en ES o SIM..."></textarea>
    <div class="row" style="margin-top:10px">
      <button id="simSend" class="btn">Enviar</button>
      <button id="simClear" class="btn sec">Limpiar</button>
    </div>
    <div id="simOut" class="out" style="margin-top:10px">--</div>
  </section>
</main>

<!-- Panel admin discreto (sobre el footer) -->
<div class="secret">
  <div class="row" style="grid-template-columns:1fr auto">
    <input id="secretPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" aria-label="Contrase√±a admin"/>
    <button id="secretUnlock" class="btn" style="width:auto">Desbloquear admin</button>
  </div>
  <div id="secretPanel" class="card" style="display:none;margin-top:10px">
    <h3>Panel administrador</h3>

    <div class="row" style="margin-bottom:8px">
      <label class="small"><input type="radio" name="mode" value="ES" checked> Buscar por Espa√±ol</label>
      <label class="small"><input type="radio" name="mode" value="SIM"> Buscar por Simlish</label>
    </div>
    <div class="row">
      <input id="searchQuery" placeholder="Buscar‚Ä¶"/>
      <button id="btnSearch" class="btn sec">Buscar</button>
    </div>
    <div id="searchInfo" class="small muted" style="margin-top:6px">Edita solo pares de <b>Usuario</b>. CORE es de solo lectura (puedes crear sobreescritura).</div>
    <div id="results" class="list"></div>

    <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

    <h4>Crear / Generar antes de guardar</h4>
    <div class="row">
      <input id="newEs" placeholder="Espa√±ol"/>
      <input id="newSim" placeholder="(generado aqu√≠)"/>
    </div>
    <div class="row" style="grid-template-columns:auto auto 1fr">
      <button id="btnGen" class="btn sec">Generar</button>
      <button id="btnCreate" class="btn">Guardar</button>
      <span class="small muted"></span>
    </div>

    <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

    <div class="row">
      <button id="btnNewTravieso" class="btn">Generar clave ‚ÄúTravieso‚Äù</button>
      <button id="btnConflicts2" class="btn sec">Ver conflictos</button>
    </div>
    <div id="traviesoBox" class="small muted" style="margin-top:8px"></div>
  </div>
</div>

<footer style="text-align:center;padding:14px;font-size:.9rem;color:var(--muted);border-top:1px solid var(--line);margin-top:16px">
  ‚òÜ Creado por <b style="color:var(--accent)">Musi Dklja</b> (2025)
</footer>

<!-- Popup de respaldo -->
<div id="backupPopup">
  <div class="card">
    <p id="popupMsg">‚Äî</p>
    <div class="row" style="margin-top:10px">
      <button id="popupDownload" class="btn">Descargar JSON</button>
      <button id="popupCancel" class="btn sec">Cancelar</button>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG B√ÅSICA ===================== */
const DIR={ES2SIM:"ES2SIM",SIM2ES:"SIM2ES"}; let CURRENT_DIR=DIR.ES2SIM;
const CORE_VERSION="3.1";
const KEY_USER=`simlishLexiconUser:${CORE_VERSION}`;
const KEY_HISTORY=`simlishLexiconHistory:${CORE_VERSION}`;
let lastLearnedCount=0;
let ADMIN_TOKEN=null; // se obtiene por /auth

// Conectamos siempre al mismo host (Render): rutas relativas
const API = {
  ping: () => fetch("/", {cache:"no-store"}).then(r=>r.json()).catch(()=>null),
  pull: () => fetch("/data", {cache:"no-store"}).then(r=>r.json()),
  push: (payload) => fetch("/data",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}),
  auth: (pass) => fetch("/auth",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pass})}).then(r=>r.json()),
  newTravieso: () => fetch("/admin/travieso/new-pass",{method:"POST",headers:{"Content-Type":"application/json","x-auth-token":ADMIN_TOKEN}}).then(r=>r.json()),
  verifyTravieso: (phrase) => fetch("/chat/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phrase})}).then(r=>r.json()),
  ml: (text,mode="simlish") => fetch("/ml",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text,mode})}).then(r=>r.json())
};

/* ===================== HELPERS ===================== */
const deacc=s=>String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");
const normEs=s=>deacc(String(s||"").toLowerCase()).trim();
const normSim=s=>String(s||"").toLowerCase().trim();
function defaultUserStore(){ return { es2sim:{}, sim2es:{} }; }
function loadUser(){ try{ return JSON.parse(localStorage.getItem(KEY_USER)||"") || defaultUserStore(); }catch{ return defaultUserStore(); } }
function saveUser(){ try{ localStorage.setItem(KEY_USER, JSON.stringify(USER)); }catch{} schedulePush(); }
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(KEY_HISTORY)||"[]"); }catch{ return []; } }
function saveHistory(){ try{ localStorage.setItem(KEY_HISTORY, JSON.stringify(HISTORY.slice(-10))); }catch{} schedulePush(); }

let USER=loadUser();
let HISTORY=loadHistory();
let pushTimer=null, dirty=false;
function schedulePush(){ dirty=true; clearTimeout(pushTimer); pushTimer=setTimeout(async()=>{
  try{ await API.push({core_version:CORE_VERSION,user:USER,history:HISTORY}); dirty=false; }catch{}
  updateHost();
}, 500); }

/* ===================== CORE DATA (vocab + phrasebook) ===================== */
const DATA = {
  gramatica:{
    orden:"Sujeto ‚Äì Verbo ‚Äì Objeto (SVO)",
    adjetivo:"Despu√©s del sustantivo",
    posesion:"Con 'ta' ‚Üí Parshu ta meeba = mi pareja",
    negacion:{ nah:"no (simple)", nuvva:"nunca / negaci√≥n fuerte" },
    plural:"Usar -s / -as / -us seg√∫n sonoridad",
    comparativos:{ moo:"m√°s", minnu:"menos", firbs:"muy" },
    tiempos:{
      auxiliar:"shoba = estar/ser",
      prefijos:{ "dra-":"pasado", "to-":"futuro" },
      sufijos:{ "-nu":"presente / en acto", "-ru":"aspecto en curso" }
    },
    interrogativos:{ harva:"qu√©/c√≥mo (general)", kujan:"c√≥mo (coloquial)" },
    conectores:{ "plubbu":"y/pero","ta":"de/que/para/a","wit":"con","palu":"para","entru":"entonces","kuzra":"porque","thooba":"aunque","sooba":"as√≠ que","hovra":"sin embargo","pleebu":"si / por ejemplo" },
    adverbios_tiempo:{ nuvra:"ahora", yestu:"ayer", todra:"antes", tombru:"ma√±ana", soonru:"pronto", dovra:"noche", sulah:"d√≠a" }
  },
  vocabulario:{
    pronombres:{ "meeba":"yo","teeba":"t√∫","heeba":"√©l","sheba":"ella","weeba":"nosotros","da":"el/la/los/las" },
    basicos:{
      "sul sul":"hola", "su laa":"bienvenidos",
      "dag dag":"chao", "da vaa":"adi√≥s",
      "yibu":"s√≠","nah":"no","nuvva":"nunca","felnu":"perd√≥n","firvu":"bien hecho","whazzu":"¬øqu√© pasa?","frezzu":"felicidades","vrashoo":"ojal√°","welbru":"bienvenido","oddru":"otro","gratvu":"gracias","prezooba":"bonito/hermoso","nibbu":"beb√©"
    },
    lugares:{ "varkun":"mercado","savrak":"escuela","tavruu":"taberna","domru":"templo","karshu":"c√°rcel","frambu":"granja","talvak":"taller","citra":"pueblo","shorva-midru":"plaza central" },
    casa:{ "grivna":"pared","tavnek":"techo","grundal":"suelo","ventra":"ventana","dorvu":"puerta","skravla":"escalera","plavru":"patio","fumrak":"chimenea","slumbaa":"cama","trabka":"mesa","krinta":"silla","garvun":"armario","lumbru":"sof√°","sholvik":"estante","glimra":"l√°mpara" },
    naturaleza:{ "dravun":"√°rbol","lurvak":"bosque","rivru":"r√≠o","lagru":"lago","morvak":"mar","mornak":"monta√±a","vallru":"valle","plavna":"pradera","skavru":"cielo","nubba":"nube","sulvar":"sol","lunvar":"luna","strovna":"estrella","wairnu":"viento","grunva":"tierra" },
    clima:{ "shusha":"lluvia","bravruu":"tormenta","drovak":"trueno","skrashu":"rayo/rel√°mpago","flavru":"nieve","kravnu":"granizo","hetru":"calor","friznu":"fr√≠o","grovna":"nube oscura","prismoo":"arco√≠ris" },
    cocina:{ "fooba":"comida","shubra":"ropa","lavru":"lavar","olbru":"olla","frilpa":"sart√©n","klivra":"cuchillo","spuvu":"cuchara","platru":"plato","glavru":"vaso","ovrak":"horno","stovru":"fuego de cocina" },
    verbos_cotidianos:{ "brazu":"cocinar","nomma":"comer","gluppa":"beber","delvu":"servir","klasha":"cortar","mashka":"masticar","travnu":"ir/ir a","gavna":"tener","dropla":"dejar caer","workru":"trabajar","zurnu":"ganas/√°nimo","showru":"aparecer/mostrar(se)" },
    sabores_estado:{ "tastu":"sabrosa","brasha":"caliente","swibbu":"dulce","salgru":"salada","bitra":"amarga","sharvu":"picante","tartu":"√°cida","fluska":"limpio" },
    cuerpo:{ "kavra":"cabeza","manru":"mano","okru":"ojo","mokra":"boca","legra":"pierna","podru":"pie","krovna":"coraz√≥n","bonka":"hueso","skarna":"piel" },
    organos:{ "bravna":"cerebro","stomru":"est√≥mago","lungra":"pulmones","livru":"h√≠gado","kidru":"ri√±√≥n","krovak":"sangre","alvra":"alma","introv":"intestino","zanvak":"eterno" },
    sentidos:{ "vooba":"ver","lurmu":"o√≠r","snorva":"oler","gustra":"saborear","takru":"tocar","senvra":"sentir","perklu":"percibir" },
    emociones:{ "jibnu":"feliz","mavruu":"triste","dranza":"cansado","blennu":"aburrido","franvu":"preocupado","satruu":"satisfecho","sumba":"calmado","zenvru":"celoso","pravna":"orgulloso","shombra":"avergonzado","gratru":"agradecido","truval":"confiado","timbru":"t√≠mido" },
    valores:{ "jusvak":"justicia","kindru":"bondad","dravru":"maldad","onrak":"honor","loybru":"lealtad","savra":"sabidur√≠a" },
    relaciones:{ "klavu":"amigo","onbru":"solo","neebu":"vecino","vorna":"l√≠der","zorvik":"enemigo","stravru":"desconocido","sambru":"compa√±ero","parshu":"pareja","lomvak":"maestro","savba":"ense√±ar","savnu":"aprender","savrin":"aprendiz" },
    animales:{ "mivvu":"gato","woofum":"perro","chirva":"ave/p√°jaro","bluppa":"pez","tranka":"caballo","bovru":"vaca","skivvi":"rat√≥n","vulka":"zorro","snorka":"cerdo","balmu":"oveja" },
    tecnologia_epico:{ "netvra":"internet","stabru":"estable","zavrush":"aventuras" },
    narrativa_raices:{ "zombru":"guiar/liderar (√©pico)","gravnu":"aldea/ciudad grande","flowru":"flujo espiritual/energ√≠a","shobru":"mostrar/revelar" },
    custom:{ "plarvoh":"ma√±ana","nurplah":"juguemos" }
  },
  phrasebook:{
    saludos:{ "Su laa!":"¬°Bienvenidos!","Kujan teeba shoba?":"¬øC√≥mo est√°s?"},
    extras_calendario:{ "Nuvra shoba Lurnas.":"Hoy es lunes.","Tombru shoba Tarnas.":"Ma√±ana ser√° martes.","Ta Mernas weeba playru Simms.":"El mi√©rcoles jugamos Sims."}
  }
};

/* ===================== √çNDICES ===================== */
let CORE_ES2SIM=new Map(), CORE_SIM2ES=new Map(), PH_ES2SIM=new Map(), PH_SIM2ES=new Map();
(function buildCore(){
  for(const entries of Object.values(DATA.vocabulario)){
    for(const [sim, es] of Object.entries(entries)){
      const espNorm=normEs(es), simNorm=normSim(sim);
      for(const v of espNorm.split(/[\/ ,]/).map(s=>s.trim()).filter(Boolean)){
        if(!CORE_ES2SIM.has(v)) CORE_ES2SIM.set(v, sim);
      }
      if(!CORE_SIM2ES.has(simNorm)) CORE_SIM2ES.set(simNorm, es.split('/')[0]);
    }
  }
  for(const group of Object.values(DATA.phrasebook||{})){
    for(const [sim, es] of Object.entries(group)){
      PH_ES2SIM.set(normEs(es), sim);
      PH_SIM2ES.set(normSim(sim), es);
    }
  }
})();

/* ===================== MULTI PALABRAS (p.ej. "su laa") ===================== */
function multiKeys(){
  const k=new Set();
  for(const entries of Object.values(DATA.vocabulario||{})){
    for(const sim of Object.keys(entries||{})){ if(sim.includes(" ")) k.add(sim.toLowerCase()); }
  }
  for(const sim of Object.keys(USER.sim2es||{})){ if(sim.includes(" ")) k.add(sim.toLowerCase()); }
  return Array.from(k).sort((a,b)=>b.length-a.length);
}
function compressMultiSim(text){
  let out=text;
  for(const key of multiKeys()){
    const re=new RegExp("\\b"+key.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"\\b","gi");
    out=out.replace(re, m=>m.replace(/\s+/g,"_"));
  }
  return out;
}
function expandMultiSimToken(t){ return t.replace(/_/g," "); }

/* ===================== CONFLICTOS ===================== */
function scanConflicts(){
  const seen=new Map(), conflicts=[];
  function addMap(obj){ for(const [es,sim] of Object.entries(obj)){ const s=normSim(sim), e=normEs(es);
    if(!seen.has(s)) seen.set(s,e); else if(seen.get(s)!==e) conflicts.push({sim:s,a:seen.get(s),b:e}); } }
  for(const entries of Object.values(DATA.vocabulario)){ for(const [sim,es] of Object.entries(entries)) addMap({[es]:sim}); }
  addMap(USER.es2sim||{});
  return conflicts;
}

/* ===================== TIEMPOS + GENERADOR ===================== */
const adv=DATA.gramatica.adverbios_tiempo||{};
const PAST_LEX=new RegExp("\\b("+["ayer","antes","ya",adv.yestu,"anoche"].filter(Boolean).join("|")+")\\b","i");
const FUT_LEX =new RegExp("\\b("+["ma√±ana","manana","luego","despu√©s","despues","pronto",adv.tombru,"pasado ma√±ana"].filter(Boolean).join("|")+")\\b","i");
const PRES_LEX=new RegExp("\\b("+["hoy","ahora","enseguida",adv.nuvra].filter(Boolean).join("|")+")\\b","i");
const RE={ ira:/\b(voy|vas|va|vamos|van)\s+a\s+[a-z√°√©√≠√≥√∫√±√º]+(ar|er|ir)\b/i, fut:/\b[a-z√°√©√≠√≥√∫√±√º]+(r√©|r√°s|r√°|remos|r√°n)\b/i,
  pret:/\b[a-z√°√©√≠√≥√∫√±√º]+(√©|aste|√≥|amos|aron|√≠|iste|i√≥|imos|ieron)\b/i, imp:/\b[a-z√°√©√≠√≥√∫√±√º]+(aba|abas|√°bamos|aban|√≠a|√≠as|√≠amos|√≠an)\b/i,
  pastIrreg:/\b(fui|fue|fuiste|fuimos|fueron|estuve|estuviste|estuvo|estuvimos|estuvieron|era|eras|√©ramos|eran|estaba|estabas|est√°bamos|estaban)\b/i,
  prog:/\b(estoy|estas|est√°|estamos|est√°n|est√°s)\s+[a-z√°√©√≠√≥√∫√±√º]+(ando|iendo|yendo)\b/i };
const TENSE={ PAST:"past", PRESENT:"present", FUTURE:"future", PROG:"progressive" };
function detectTense(es){ if(RE.prog.test(es))return TENSE.PROG; if(FUT_LEX.test(es)||RE.ira.test(es)||RE.fut.test(es))return TENSE.FUTURE; if(PAST_LEX.test(es)||RE.pret.test(es)||RE.imp.test(es)||RE.pastIrreg.test(es))return TENSE.PAST; if(PRES_LEX.test(es))return TENSE.PRESENT; return TENSE.PRESENT; }

function xorshift32(seed){ let x=seed|0; return ()=> (x^=x<<13,x^=x>>>17,x^=x<<5,(x>>>0)/4294967296); }
function hashStr(s){ let h=2166136261>>>0; for(const c of s) h=Math.imul(h ^ c.charCodeAt(0),16777619); return h>>>0; }
const SYLL=["su","la","noo","boo","zim","zam","sha","bah","voh","plar","gib","yib","flo","fru","doo","ka","ru","shi","ku","va","na","mo","ta","re","lo"];
function ensureUniqueSim(sim, es){
  const base=normSim(sim);
  const owner = (USER.sim2es[base] ? {scope:"USER"} : (CORE_SIM2ES.has(base) ? {scope:"CORE"} : null));
  if(!owner) return sim;
  if(USER.sim2es[base] && normEs(USER.sim2es[base])===normEs(es)) return sim;
  const suff=["ah","eh","oh","nu","ru","va","la","ra","ba"];
  for(const s of suff){ const cand=base+s; if(!(USER.sim2es[cand]||CORE_SIM2ES.has(cand))) return sim.replace(base, cand); }
  let i=2; while(USER.sim2es[base+i]||CORE_SIM2ES.has(base+i)) i++; return sim.replace(base, base+i);
}
function synth(word){
  const w=normEs(word).replace(/[^a-z0-9\s]/g,""); if(!w) return word;
  const rnd=xorshift32(hashStr(w)); let n=Math.max(2,Math.min(4,Math.ceil(w.length/4)));
  let out=[]; for(let i=0;i<n;i++) out.push(SYLL[Math.floor(rnd()*SYLL.length)]);
  let res=out.join(""); if(/r$/.test(w)) res+="ru"; if(/n$/.test(w)) res+="nu"; return ensureUniqueSim(res, word);
}

/* ===================== APRENDIZAJE ===================== */
function tokensOf(text){ return text.match(/[\w√°√©√≠√≥√∫√±√º_]+|[.,;:!?]/gi) || [text]; }
function learnPairs(pairs){
  let learned=0, stamped=[];
  for(const [esRaw, simRaw] of pairs){
    const es=String(esRaw||"").trim();
    const simCand=String(simRaw||"").trim() || synth(es);
    const sim=ensureUniqueSim(simCand, es);
    const kEs=normEs(es), kSim=normSim(sim);
    if(!kEs || !kSim) continue;

    const prevSim=USER.es2sim[kEs]; if(prevSim && normSim(prevSim)!==kSim){ delete USER.sim2es[normSim(prevSim)]; }
    const prevEs =USER.sim2es[kSim]; if(prevEs && normEs(prevEs)!==kEs){ delete USER.es2sim[normEs(prevEs)]; }

    if(!USER.es2sim[kEs]){ USER.es2sim[kEs]=sim; learned++; }
    USER.sim2es[kSim]=es;
    stamped.push({es,sim,t:new Date().toISOString()});
  }
  if(stamped.length){ HISTORY=[...HISTORY, ...stamped].slice(-10); saveHistory(); }
  if(learned>0) saveUser();
  return learned;
}

/* ===================== TRADUCCI√ìN ===================== */
function translateES2SIM(text){
  const sentences = text.match(/[^.!?]+[.!?]?/g) || [text];
  let newPairs=[];
  const out = sentences.map(raw=>{
    const s=raw.trim(); if(!s) return "";
    const pb=PH_ES2SIM.get(normEs(s.replace(/[.!?]$/,""))); if(pb) return pb;

    const hasNever=/\bnunca\b/i.test(s), hasNo=/\bno\b/i.test(s); const NEG=hasNever?"nuvva":(hasNo?"nah":"");
    const tense=detectTense(s); const toks=tokensOf(s); const simToks=[]; let injected=false;

    for(const t of toks){
      if(/^[.,;:!?]$/.test(t)){ simToks.push(t); continue; }
      const key=normEs(t);
      let sim=USER.es2sim[key] || CORE_ES2SIM.get(key);
      if(!sim){ sim=synth(t); newPairs.push([key, sim]); } else { sim=ensureUniqueSim(sim, t); }

      const isVerb=["brazu","nomma","gluppa","delvu","klasha","mashka","travnu","gavna","dropla","workru","zurnu","showru"].includes(normSim(sim));
      if(!injected && isVerb){
        let pref="", suf="", aux="shoba";
        if(tense===TENSE.PAST) pref="dra-"; else if(tense===TENSE.FUTURE) pref="to-"; else if(tense===TENSE.PRESENT) suf="-nu"; else if(tense===TENSE.PROG) suf="-ru";
        let phrase=`${aux} ${pref}${sim}${suf}`; if(NEG) phrase=`${NEG} ${phrase}`;
        simToks.push(phrase); injected=true;
      }else{
        if(/^no$|^nunca$/i.test(t)) continue;
        simToks.push(sim);
      }
    }
    let outS=simToks.join(" ").replace(/\s+([.,;:!?])/g,"$1").replace(/\s+/g," ").trim();
    if(outS) outS=outS.charAt(0).toUpperCase()+outS.slice(1);
    return outS;
  }).join(" ");
  lastLearnedCount = learnPairs(newPairs);
  return out;
}

function translateSIM2ES(text){
  const sentences = text.match(/[^.!?]+[.!?]?/g) || [text];
  const out = sentences.map(raw=>{
    const s=raw.trim(); if(!s) return "";

    const pb=PH_SIM2ES.get(normSim(s.replace(/[.!?]$/,""))); if(pb) return pb;

    const pre=compressMultiSim(s);
    const toks=tokensOf(pre); const esToks=[];
    for(const t0 of toks){
      if(/^[.,;:!?]$/.test(t0)){ esToks.push(t0); continue; }
      const t=expandMultiSimToken(t0);
      const key=normSim(t);
      let es=USER.sim2es[key] || CORE_SIM2ES.get(key);
      if(!es){
        const base=key.replace(/^(dra-|to-)/,"").replace(/(-nu|-ru)$/,"");
        es=USER.sim2es[base] || CORE_SIM2ES.get(base);
      }
      if(!es) es=t;
      esToks.push(es);
    }
    let outS=esToks.join(" ").replace(/\s+([.,;:!?])/g,"$1").replace(/\s+/g," ").trim();
    if(outS) outS=outS.charAt(0).toUpperCase()+outS.slice(1);
    return outS;
  }).join(" ");
  return out;
}

/* ===================== UI BASICS ===================== */
const $in=doc("in"),$out=doc("out"),$dirLabel=doc("dirLabel"),$stateDirVal=doc("stateDirVal");
const $stateLearnVal=doc("stateLearnVal"),$confCount=doc("confCount"),$hostState=doc("hostState");
doc("toggleDir").onclick=()=>{ CURRENT_DIR=(CURRENT_DIR===DIR.ES2SIM?DIR.SIM2ES:DIR.ES2SIM); const lbl=(CURRENT_DIR===DIR.ES2SIM?"ES ‚Üí SIM":"SIM ‚Üí ES"); $dirLabel.textContent=lbl; $stateDirVal.textContent=lbl.replace(" ",""); };
doc("translate").onclick=doTranslate;
doc("clear").onclick=()=>{ $in.value=""; $out.textContent="--"; lastLearnedCount=0; refreshMeta(); };
doc("copy").onclick=async()=>{ const txt=$out.textContent.trim(); if(!txt||txt==="--") return alert("No hay texto para copiar."); await navigator.clipboard.writeText(txt); };
doc("demo").onclick=()=>{ if(CURRENT_DIR===DIR.ES2SIM) $in.value="Ayer cocin√© sopa caliente y ma√±ana la compartir√©."; else $in.value="Su laa, meeba shoba dra-brazu supa brasha."; doTranslate(); };
doc("btnExport").onclick=()=>{ window.location.href="/backup/download"; };
doc("btnConflicts").onclick=renderConflicts;
doc("btnConflicts2").onclick=renderConflicts;

function doc(id){ return document.getElementById(id); }
function doTranslate(){
  const raw=($in.value||"").trim(); if(!raw){ $out.textContent="--"; refreshMeta(); return; }
  const res = (CURRENT_DIR===DIR.ES2SIM ? translateES2SIM(raw) : translateSIM2ES(raw));
  $out.textContent=res||"--"; refreshMeta();
}
function refreshMeta(){
  $stateLearnVal.textContent=String(lastLearnedCount||0);
  const confs=scanConflicts(); $confCount.textContent=String(confs.length);
  // historial
  const $h=doc("history");
  const arr=(Array.isArray(HISTORY)?HISTORY:[]).slice(-10);
  $h.innerHTML = arr.length? arr.map(h=>`‚Ä¢ <b>${h.es}</b> ‚Üî <i>${h.sim}</i> <span class="muted">(${new Date(h.t||Date.now()).toLocaleString()})</span>`).join("<br>") : "--";
  // meta
  const cats=Object.keys(DATA.vocabulario||{}); let totalCore=0; for(const c of cats) totalCore+=Object.keys(DATA.vocabulario[c]).length;
  const phCount=Object.values(DATA.phrasebook||{}).reduce((a,g)=>a+Object.keys(g).length,0);
  doc("meta").textContent=`Categor√≠as: ${cats.length} ¬∑ Entradas base: ${totalCore} ¬∑ Phrasebook: ${phCount} ¬∑ Usuario: ${Object.keys(USER.es2sim).length}/${Object.keys(USER.sim2es).length}`;
}

/* ===================== SYNC HOST ===================== */
async function pullFromHost(){
  try{
    const r=await API.pull(); if(r && r.user){
      USER = { es2sim:{}, sim2es:{}, ...(r.user||{}) };
      HISTORY = Array.isArray(r.history)? r.history.slice(-10) : [];
      saveUser(); saveHistory();
    }
  }catch{}
  updateHost(); refreshMeta();
}
async function updateHost(){ try{ const ok=await API.ping(); $hostState.textContent = ok && ok.ok ? "OK" : "Sin respuesta"; }catch{ $hostState.textContent="Sin respuesta"; } }

/* ===================== ADMIN PANEL ===================== */
doc("secretUnlock").onclick=async()=>{
  const pass=(doc("secretPass").value||"").trim(); if(!pass) return alert("Escribe la contrase√±a.");
  const r=await API.auth(pass);
  if(r && r.ok){ ADMIN_TOKEN=r.token; sessionStorage.setItem("admintoken",ADMIN_TOKEN); doc("secretPass").value=""; doc("secretPanel").style.display="block"; }
  else alert("Contrase√±a incorrecta.");
};
(function restoreAdmin(){ const t=sessionStorage.getItem("admintoken"); if(t){ ADMIN_TOKEN=t; doc("secretPanel").style.display="block"; } })();

// Buscar/editar/borrar
doc("btnSearch").onclick=()=>{
  const q=(doc("searchQuery").value||"").trim().toLowerCase();
  const mode = Array.from(document.querySelectorAll('input[name="mode"]')).find(r=>r.checked)?.value || "ES";
  renderResults(resultsFromQuery(q, mode));
};
doc("btnGen").onclick=()=>{ const es=(doc("newEs").value||"").trim(); if(!es) return alert("Escribe Espa√±ol."); doc("newSim").value=ensureUniqueSim(synth(es), es); };
doc("btnCreate").onclick=()=>{
  const es=(doc("newEs").value||"").trim(); let sim=(doc("newSim").value||"").trim();
  if(!es) return alert("Debes escribir Espa√±ol."); if(!sim) sim=ensureUniqueSim(synth(es), es);
  const kEs=normEs(es), kSim=normSim(sim);
  const prevSim=USER.es2sim[kEs]; if(prevSim && prevSim!==sim){ delete USER.sim2es[normSim(prevSim)]; }
  const prevEs=USER.sim2es[kSim]; if(prevEs && prevEs!==es){ delete USER.es2sim[normEs(prevEs)]; }
  USER.es2sim[kEs]=sim; USER.sim2es[kSim]=es;
  HISTORY=[...HISTORY,{es,sim,t:new Date().toISOString()}].slice(-10); saveUser(); saveHistory();
  doc("newEs").value=""; doc("newSim").value=""; renderResults([{scope:"USER",es,sim}]); refreshMeta();
};

function resultsFromQuery(q, mode){
  const items=[]; if(!q) return items;
  if(mode==="ES"){
    for(const [es,sim] of Object.entries(USER.es2sim||{})){ if(es.includes(q)) items.push({scope:"USER",es,sim}); }
    for(const [es,sim] of CORE_ES2SIM.entries()){ if(es.includes(q) && !(USER.es2sim&&USER.es2sim[es])) items.push({scope:"CORE",es,sim}); }
  }else{
    for(const [sim,es] of Object.entries(USER.sim2es||{})){ if(sim.includes(q)) items.push({scope:"USER",es,sim}); }
    for(const [sim,es] of CORE_SIM2ES.entries()){ if(sim.includes(q) && !(USER.sim2es&&USER.sim2es[sim])) items.push({scope:"CORE",es,sim}); }
  }
  return items.slice(0,100);
}
function renderResults(list){
  const $r=doc("results"); $r.innerHTML="";
  if(!list||!list.length){ $r.innerHTML=`<div class="small muted">Sin resultados.</div>`; return; }
  list.forEach(item=>{
    const isCore=item.scope==="CORE";
    const esId="es_"+Math.random().toString(36).slice(2);
    const simId="sim_"+Math.random().toString(36).slice(2);
    const row=document.createElement("div"); row.className="item";
    row.innerHTML=`
      <div class="row3">
        <input id="${esId}" value="${item.es}" ${isCore?'disabled':''} title="${isCore?'CORE (solo lectura)':'Espa√±ol'}"/>
        <input id="${simId}" value="${item.sim}" ${isCore?'disabled':''} title="${isCore?'CORE (solo lectura)':'Simlish'}"/>
        <div class="row" style="grid-template-columns:auto auto">
          <button class="btn sec" data-act="override" ${isCore?'':'style="display:none"'}>Sobrescribir</button>
          <button class="btn danger" data-act="delete" ${isCore?'disabled':''}>Borrar</button>
        </div>
      </div>
      <small class="muted">${isCore? 'CORE ¬∑ Crea sobreescritura para cambiarlo.' : 'Usuario ¬∑ Editable'}</small>
    `;
    // guardar edici√≥n directa (si es USER)
    if(!isCore){
      row.querySelector(`#${esId}`).addEventListener("change", ()=>{
        const newEs=row.querySelector(`#${esId}`).value.trim(); const oldEs=item.es;
        const sim=row.querySelector(`#${simId}`).value.trim();
        if(!newEs||!sim) return;
        delete USER.es2sim[normEs(oldEs)];
        USER.es2sim[normEs(newEs)]=sim;
        USER.sim2es[normSim(sim)]=newEs;
        HISTORY=[...HISTORY,{es:newEs,sim,t:new Date().toISOString()}].slice(-10); saveUser(); saveHistory(); refreshMeta();
      });
      row.querySelector(`#${simId}`).addEventListener("change", ()=>{
        const es=row.querySelector(`#${esId}`).value.trim(); const sim=row.querySelector(`#${simId}`).value.trim();
        if(!es||!sim) return;
        USER.es2sim[normEs(es)]=sim; USER.sim2es[normSim(sim)]=es;
        HISTORY=[...HISTORY,{es,sim,t:new Date().toISOString()}].slice(-10); saveUser(); saveHistory(); refreshMeta();
      });
    }
    // borrar (solo USER)
    row.querySelector('[data-act="delete"]')?.addEventListener("click", ()=>{
      if(isCore) return;
      const es=row.querySelector(`#${esId}`).value.trim(); const sim=row.querySelector(`#${simId}`).value.trim();
      if(!es||!sim) return;
      delete USER.es2sim[normEs(es)]; delete USER.sim2es[normSim(sim)];
      saveUser(); refreshMeta(); row.remove();
    });
    // sobrescribir CORE ‚Üí crea USER
    row.querySelector('[data-act="override"]')?.addEventListener("click", ()=>{
      const es=row.querySelector(`#${esId}`).value.trim(); const sim=row.querySelector(`#${simId}`).value.trim();
      if(!es||!sim) return;
      const sug=ensureUniqueSim(sim, es);
      USER.es2sim[normEs(es)]=sug; USER.sim2es[normSim(sug)]=es;
      HISTORY=[...HISTORY,{es,sim:sug,t:new Date().toISOString()}].slice(-10); saveUser(); saveHistory();
      alert("Sobrescritura creada en Usuario: "+es+" ‚Üî "+sug);
    });

    doc("results").appendChild(row);
  });
}
function renderConflicts(){
  const confs=scanConflicts();
  if(!confs.length) return alert("Sin conflictos üéâ");
  const lines = confs.map(c=>`‚Ä¢ SIM "${c.sim}" ‚Üí ES "${c.a}" y "${c.b}"`).join("\n");
  alert("Conflictos encontrados:\n\n"+lines+"\n\nSoluci√≥n: crea una sobreescritura en Usuario o edita/borras en el panel.");
}

/* ===================== SIM CHAT ===================== */
let currentPers="clasico";
document.querySelectorAll(".chipbtn").forEach(b=>{
  b.onclick=async()=>{
    const p=b.dataset.pers;
    if(p==="travieso"){
      const phrase=prompt("Frase traviesa (pregunta al admin):");
      if(!phrase) return;
      const v=await API.verifyTravieso(phrase);
      if(!v.ok) return alert("Frase incorrecta.");
    }
    document.querySelectorAll(".chipbtn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active"); currentPers=p;
  };
});
doc("simSend").onclick=async()=>{
  const msg=(doc("simIn").value||"").trim(); if(!msg) return;
  try{
    const r=await API.ml(msg,"chat");
    appendSimChat("T√∫", msg);
    appendSimChat("Sim", `${r.simlish}\n(${r.es})`);
    doc("simIn").value="";
  }catch{ appendSimChat("Sistema","(sin respuesta ML)"); }
};
doc("simClear").onclick=()=>{ doc("simOut").textContent="--"; };
function appendSimChat(who, text){
  const box=doc("simOut");
  if(box.textContent==="--") box.textContent="";
  box.textContent += `${who}: ${text}\n\n`;
  box.scrollTop = box.scrollHeight;
}

// Needs (indicadores visibles; l√≥gica simple local)
const Needs={H:6,D:6,I:6,E:6,S:6,V:6}; // 0-9
function paintNeeds(){
  paint("needH",Needs.H); paint("needD",Needs.D); paint("needI",Needs.I);
  paint("needE",Needs.E); paint("needS",Needs.S); paint("needV",Needs.V);
}
function paint(id,val){ const el=doc(id); for(let i=0;i<=9;i++) el.classList.remove("g"+i); el.classList.add("g"+Math.max(0,Math.min(9,val))); }
setInterval(()=>{
  // Drenado base
  Needs.D=Math.max(0,Needs.D - (Math.random()<0.4?1:0));
  Needs.S=Math.max(0,Needs.S - (Math.random()<0.6?1:0));
  // Energ√≠a nocturna baja m√°s r√°pido (23-7)
  const h=new Date().getHours();
  if(h>=23 || h<7){ Needs.E=Math.max(0,Needs.E-1); }
  // Hambre cada ~2h
  if(Math.random()<0.2) Needs.H=Math.max(0,Needs.H-1);
  // Higiene y Vejiga
  if(Math.random()<0.15) Needs.I=Math.max(0,Needs.I-1);
  if(Math.random()<0.25) Needs.V=Math.max(0,Needs.V-1);
  paintNeeds();
}, 60*1000); // cada minuto
paintNeeds();

/* ===================== POPUP BACKUP (Lunes y Viernes; reintenta cada hora) ===================== */
const popup=doc("backupPopup"), $msg=doc("popupMsg");
doc("popupDownload").onclick=()=>{ popup.style.display="none"; window.location.href="/backup/download"; };
doc("popupCancel").onclick=async()=>{
  popup.style.display="none";
  try{ const r=await API.ml("no quiero ahora","simlish"); alert(r.simlish); }catch{}
};
function shouldShowPopup(){
  const d=new Date(), day=d.getDay(); // 1=Lunes, 5=Viernes
  if(!(day===1 || day===5)) return false;
  const key="backupLastShown:"+d.toDateString();
  const last=localStorage.getItem(key);
  const now=Date.now();
  if(!last || (now-Number(last)) > 60*60*1000){ localStorage.setItem(key,String(now)); return true; }
  return false;
}
async function showPopupIfNeeded(){
  if(!shouldShowPopup()) return;
  try{
    const r=await API.ml("haz un respaldo del diccionario ahora","simlish");
    $msg.textContent = `Vrashoo: realiza un respaldo del diccionario.\n(${r.simlish})`;
  }catch{ $msg.textContent = "¬°Hora de respaldar tu diccionario!"; }
  popup.style.display="grid";
}
setInterval(showPopupIfNeeded, 10*60*1000); // chequeo cada 10 min
showPopupIfNeeded();

/* ===================== INICIO ===================== */
function doInit(){ pullFromHost(); refreshMeta(); updateHost(); }
doInit();

/* ===================== UTILS FIN ===================== */
</script>
</body>
</html>
