<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Simlish Translator ¬∑ ES ‚áÑ SIM ¬∑ Core v3.1</title>
<meta name="description" content="Traductor bidireccional Espa√±ol ‚áÑ Simlish con aprendizaje y sincronizaci√≥n estricta a backend.">
<!-- CSP: solo self y tu backend en Render -->
<meta http-equiv="Content-Security-Policy"
  content="default-src 'self';
           connect-src 'self' https://simlish-translator-backend.onrender.com;
           img-src 'self' https: data:;
           script-src 'self' 'unsafe-inline';
           style-src  'self' 'unsafe-inline';
           base-uri 'self';
           frame-ancestors 'self'">
<style>
  :root{ --bg:#06141a; --bg2:#071e24; --ink:#e6f7f4; --muted:#93c5c9; --line:#0f2e35; --accent:#22d3a6; --accent-strong:#10b981; --accent-warn:#eab308; --tiktok:#38bdf8; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; background:radial-gradient(1200px 800px at 15% -10%, #0a2b2f 0%, transparent 50%), linear-gradient(180deg,#041017,#06141a 35%, #06141a 100%); color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; overflow-x:hidden; }
  header{padding:20px 24px;border-bottom:1px solid var(--line);background:#06141acc;backdrop-filter:blur(6px)}
  h1{margin:0;font-size:1.25rem;display:flex;gap:10px;align-items:center}
  .pill{display:inline-block;background:var(--accent);color:#04201a;padding:2px 10px;border-radius:999px;font-weight:800;font-size:.8rem}
  .wrap{padding:20px 24px 28px;display:grid;gap:16px;max-width:1100px;margin:0 auto}
  .grid{display:grid;gap:16px}
  @media(min-width:950px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--bg2);border:1px solid var(--line);border-radius:16px;padding:16px}
  label{display:block;margin-bottom:8px}
  textarea,button,input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#071b20;color:var(--ink)}
  textarea{min-height:170px;resize:vertical}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .btn{cursor:pointer;transition:filter .15s ease, transform .05s ease;background:linear-gradient(180deg,var(--accent) 0%, var(--accent-strong) 100%);color:#052018;font-weight:800;border:none}
  .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
  .btn.sec{background:#071b20;border:1px solid var(--line);color:var(--ink);font-weight:600}
  .out{white-space:pre-wrap;min-height:170px;border-radius:12px;border:1px dashed var(--line);padding:10px;background:#06141a;word-break:break-word;overflow-wrap:anywhere}
  .muted{color:var(--muted);font-size:.92rem}
  .small{font-size:.85rem}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#071b20;padding:6px 10px;border-radius:999px}
  .state{display:flex;gap:8px;flex-wrap:wrap}
  .ok{color:var(--accent-strong)} .warn{color:var(--accent-warn)}
  .dirbtn{display:flex;align-items:center;justify-content:center;gap:8px;font-weight:800;width:auto;min-width:180px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#071b20;border:1px solid #2a2f40;border-bottom-width:2px;border-radius:6px;padding:1px 6px}
  details summary{cursor:pointer}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  a{color:var(--tiktok);text-decoration:none;font-weight:600}
  a:hover{text-decoration:underline}
  /* Admin discreto */
  .secret{max-width:1100px;margin:0 auto;padding:0 24px 12px}
  .list{display:grid;gap:8px;margin-top:8px}
  .item{display:grid;gap:8px;border:1px dashed var(--line);border-radius:12px;padding:10px;background:#06181e}
  .item .row2{display:grid;grid-template-columns:1fr 1fr auto auto;gap:8px}
  .item small{color:var(--muted)}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chipOpt{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#071b20;padding:6px 10px;border-radius:999px}
  .confList{margin-top:10px;border:1px dashed var(--line);border-radius:12px;padding:10px;background:#06181e}
  .confItem{padding:8px;border:1px solid var(--line);border-radius:10px;margin-top:8px;background:#071b20}
  .confItem b{color:var(--accent)}
  /* NUEVO: secci√≥n de importaci√≥n */
  .importWrap{display:grid;gap:10px;margin-top:12px}
  .importActions{display:flex;gap:8px;flex-wrap:wrap}
  .hint{font-size:.8rem;color:var(--muted)}
</style>
</head>
<body>
  <header>
    <h1>Simlish Translator <span class="pill">ES ‚áÑ SIM ¬∑ Core v3.1</span></h1>
  </header>

  <main class="wrap">
    <section class="grid">
      <div class="card">
        <div class="row" style="grid-template-columns:1fr auto">
          <label for="in" style="margin:0;align-self:center">Entrada</label>
          <button id="toggleDir" class="btn dirbtn" title="Cambiar direcci√≥n"><span id="dirLabel">ES ‚Üí SIM</span></button>
        </div>
        <textarea id="in" placeholder="Escribe aqu√≠."></textarea>
        <div class="row" style="margin-top:12px">
          <button id="translate" class="btn">Traducir</button>
          <button id="clear" class="btn sec" title="Borrar texto">Limpiar</button>
        </div>
        <p class="muted small">Aprendizaje estricto: sincroniza y guarda autom√°ticamente en el backend oficial.</p>
        <div class="toolbar">
          <button id="exportBtn" class="btn sec" title="Exportar respaldo">Exportar respaldo (.json)</button>
        </div>
        <div id="strictBanner" class="small muted" style="display:none"></div>
      </div>

      <div class="card">
        <label for="out">Salida</label>
        <div id="out" class="out" aria-live="polite">--</div>
        <div class="row" style="margin-top:12px">
          <button id="copy" class="btn">Copiar</button>
          <button id="demo" class="btn sec" title="Ejemplo r√°pido">Ejemplo</button>
        </div>
        <div class="state" style="margin-top:12px">
          <span class="chip">Modo: <b>Estricto</b></span>
          <span class="chip">Direcci√≥n: <b id="stateDirVal">ES‚ÜíSIM</b></span>
          <span class="chip">Versi√≥n base: <b>3.1</b></span>
          <span class="chip">Aprendidos (√∫lt. op.): <b id="stateLearnVal">0</b></span>
          <span class="chip" id="confBadge" style="cursor:pointer" title="Ver conflictos">Conflictos: <b id="confCount">0</b></span>
          <span class="chip">Lex: <b id="metaLex">-</b></span>
          <span class="chip" id="hostChip" title="Estado de sincronizaci√≥n con host">Host: <b id="hostState">Listo</b></span>
        </div>
        <div id="confList" class="confList" style="display:none"></div>
      </div>
    </section>

    <section class="card">
      <details open>
        <summary><strong>Historial (√∫ltimos 10 aprendidos)</strong></summary>
        <div id="history" class="small muted" style="margin-top:8px">--</div>
      </details>
      <details style="margin-top:12px">
        <summary><strong>Gram√°tica & Vocab cargados</strong></summary>
        <div class="small muted" id="meta"></div>
      </details>
      <p class="muted small" style="margin-top:10px">
        Tiempos: prefijos <span class="kbd">dra-</span>/<span class="kbd">to-</span>, sufijos <span class="kbd">-nu</span>/<span class="kbd">-ru</span> con auxiliar <span class="kbd">shoba</span>.
      </p>
    </section>

    <!-- ===== Panel secreto (sobre el footer) ===== -->
    <div class="secret">
      <div class="row" style="grid-template-columns:1fr auto">
        <input id="secretPass" type="password" placeholder="" aria-label=""/>
        <button id="secretUnlock" class="btn" style="width:auto">OK</button>
      </div>
      <div id="secretPanel" class="card" style="display:none;margin-top:10px">
        <!-- Buscador / Editor -->
        <div class="chips" style="margin-bottom:8px">
          <label class="chipOpt"><input type="radio" name="mode" value="ES" checked> ES</label>
          <label class="chipOpt"><input type="radio" name="mode" value="SIM"> SIM</label>
          <button id="btnRescan" class="btn sec" style="margin-left:auto;width:auto">Re-escanear conflictos</button>
        </div>
        <div class="row">
          <input id="searchQuery" placeholder="buscar‚Ä¶"/>
          <button id="btnSearch" class="btn sec">Buscar</button>
        </div>
        <div id="searchInfo" class="small muted" style="margin-top:6px">Edita solo pares de <b>Usuario</b>. CORE es de solo lectura.</div>
        <div id="results" class="list"></div>

        <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

        <!-- Generador previo a guardar -->
        <div class="row">
          <input id="newEs" placeholder="Espa√±ol"/>
          <input id="newSim" placeholder="(generado aqu√≠)"/>
        </div>
        <div class="row" style="grid-template-columns:auto auto 1fr">
          <button id="btnGen" class="btn sec">Generar</button>
          <button id="btnCreate" class="btn">Guardar</button>
          <span class="small muted"></span>
        </div>

        <!-- ================= NUEVA SECCI√ìN: Importar respaldo ================= -->
        <hr style="border:none;border-top:1px solid var(--line);margin:16px 0">
        <details open>
          <summary><strong>Cargar respaldo (.json) ‚Äî Admin</strong></summary>
          <div class="importWrap">
            <div class="hint">Puedes pegar el JSON o seleccionar un archivo exportado con ‚ÄúExportar respaldo (.json)‚Äù.</div>
            <div class="row" style="grid-template-columns:1fr auto">
              <textarea id="importJson" placeholder='Pega aqu√≠ el JSON del respaldo‚Ä¶'></textarea>
              <div style="display:flex;flex-direction:column;gap:8px">
                <input id="importFile" type="file" accept="application/json"/>
                <button id="btnLoadFile" class="btn sec" type="button" title="Leer archivo y volcar al cuadro">Leer archivo</button>
              </div>
            </div>
            <div class="importActions">
              <select id="importMode" title="Modo de carga" style="max-width:220px">
                <option value="merge">Fusionar (conservar y sumar)</option>
                <option value="replace">Reemplazar (sobrescribe todo Usuario)</option>
              </select>
              <button id="btnPreviewImport" class="btn sec" type="button">Previsualizar</button>
              <button id="btnDoImport" class="btn" type="button">Aplicar</button>
              <span id="importInfo" class="hint"></span>
            </div>
          </div>
        </details>
        <!-- ================================================================ -->

      </div>
    </div>
    <!-- ===== /Panel secreto ===== -->

  </main>

  <footer style="text-align:center;padding:16px;font-size:.85rem;color:var(--muted);border-top:1px solid var(--line);margin-top:24px">
    <a href="https://www.tiktok.com/@musimiau?_t=ZM-8stssM0VX78&_r=1" target="_blank">@musimiau en TikToküß°üíú</a>
    <br>
    ‚òÜ Creado por <b style="color:var(--accent)">&nbsp;Musi Dklja&nbsp;</b> (28 de Agosto del 2025)
  </footer>

<script>
/* ===================== CONFIG + HELPERS ===================== */
const CORE_VERSION = "3.1";
const STRICT_MODE = true;
const KEY_USER = `simlishLexiconUser:${CORE_VERSION}`;
const KEY_HISTORY = `simlishLexiconHistory:${CORE_VERSION}`;
const DIR = { ES2SIM:"ES2SIM", SIM2ES:"SIM2ES" };
let CURRENT_DIR = DIR.ES2SIM;
let lastLearnedCount = 0;

/* Backend forzado */
const BACKEND_URL = "https://simlish-translator-backend.onrender.com/";
let pushTimer = null, pulling = false, lastPushOk = null, dirtySinceLastPush = false;

/* Admin password: se compara contra hash (no exponemos la clave en texto) */
const PASS_SHA256_HEX = "7f62619786ad59b250343204be7eba3b6adf943139684e185ab7234e8dc7d774"; // hash de tu clave
async function verifyPass(pass){
  if(!window.crypto?.subtle) return false;
  const enc = new TextEncoder().encode(pass);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  const arr = Array.from(new Uint8Array(buf));
  const hex = arr.map(b=>b.toString(16).padStart(2,"0")).join("");
  return hex === PASS_SHA256_HEX;
}

const deacc = s => String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");
const normEs = s => deacc(String(s||"").toLowerCase()).trim();
const normSim = s => String(s||"").toLowerCase().trim();

function defaultUserStore(){ return { es2sim:{}, sim2es:{} }; }
function loadUser(){ try{ return JSON.parse(localStorage.getItem(KEY_USER)||"") || defaultUserStore(); } catch{ return defaultUserStore(); } }
function saveUser(store){ try{ localStorage.setItem(KEY_USER, JSON.stringify(store)); }catch{} dirtySinceLastPush = true; schedulePushToHost(); }
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(KEY_HISTORY)||"[]"); }catch{ return []; } }
function saveHistory(list){ try{ localStorage.setItem(KEY_HISTORY, JSON.stringify(list.slice(-10))); }catch{} dirtySinceLastPush = true; schedulePushToHost(); }
function canLearn(){ return true; }

let USER = loadUser();
let HISTORY = loadHistory();

/* ===================== DICCIONARIO COMPLETO (Core v3.1, con ajustes) ===================== */
const DATA = { /* ... (SIN CAMBIOS) ... */ };
/* NOTA: el bloque DATA se mantiene id√©ntico al original. Por brevedad se omite aqu√≠,
   pero en tu archivo final conserva todo el contenido original de DATA tal cual. */

/* ===================== √çNDICES CORE + PHRASEBOOK ===================== */
let CORE_ES2SIM=new Map(), CORE_SIM2ES=new Map(), PH_ES2SIM=new Map(), PH_SIM2ES=new Map();
(function buildCore(){
  for(const entries of Object.values(DATA.vocabulario)){
    for(const [sim, es] of Object.entries(entries)){
      const espNorm = normEs(es), simNorm = normSim(sim);
      const variants = espNorm.split(/[\/,]/).map(s=>s.trim()).filter(Boolean);
      for(const v of variants){ if(!CORE_ES2SIM.has(v)) CORE_ES2SIM.set(v, sim); }
      if(!CORE_SIM2ES.has(simNorm)) CORE_SIM2ES.set(simNorm, es.split('/')[0]);
    }
  }
  for(const group of Object.values(DATA.phrasebook||{})){
    for(const [sim, es] of Object.entries(group)){
      PH_ES2SIM.set(normEs(es), sim);
      PH_SIM2ES.set(normSim(sim), es);
    }
  }
})();

/* ===================== MULTI-PALABRAS SIMLISH ===================== */
function getMultiSimKeys(){ /* ...igual... */ }
function compressMultiSim(text){ /* ...igual... */ }
function expandMultiSimToken(token){ return token.replace(/_/g, " "); }

/* ===================== Utilidades varias ===================== */
function currentSimOwner(sim){ /* ...igual... */ }
function preserveCase(o,r){ /* ...igual... */ }
function ensureUniqueSim(sim, es){ /* ...igual... */ }
function esSynSet(esStr){ /* ...igual... */ }

/* Conflictos con sin√≥nimos (igual) */
function scanConflicts(){ /* ...igual... */ }

/* ===================== Tiempos + Generador + Aprendizaje ===================== */
const adv = DATA.gramatica.adverbios_tiempo || {};
const PAST_LEX=new RegExp("\\b("+["ayer","antes","ya",adv.yestu,"anoche"].filter(Boolean).join("|")+")\\b","i");
const FUT_LEX=new RegExp("\\b("+["ma√±ana","manana","luego","despu√©s","despues","pronto",adv.tombru,"pasado ma√±ana"].filter(Boolean).join("|")+")\\b","i");
const PRES_LEX=new RegExp("\\b("+["hoy","ahora","enseguida",adv.nuvra].filter(Boolean).join("|")+")\\b","i");
const RE={ ira:/\b(voy|vas|va|vamos|van)\s+a\s+[a-z√°√©√≠√≥√∫√±√º]+(ar|er|ir)\b/i, fut:/\b[a-z√°√©√≠√≥√∫√±√º]+(r√©|r√°s|r√°|remos|r√°n)\b/i,
  pret:/\b[a-z√°√©√≠√≥√∫√±√º]+(√©|aste|√≥|amos|aron|√≠|iste|i√≥|imos|ieron)\b/i, imp:/\b[a-z√°√©√≠√≥√∫√±√º]+(aba|abas|√°bamos|aban|√≠a|√≠as|√≠amos|√≠an)\b/i,
  pastIrreg:/\b(fui|fue|fuiste|fuimos|fueron|estuve|estuviste|estuvo|estuvimos|estuvieron|era|eras|√©ramos|eran|estaba|estabas|est√°bamos|estaban)\b/i,
  prog:/\b(estoy|estas|est√°|estamos|est√°n|est√°s)\s+[a-z√°√©√≠√≥√∫√±√º]+(ando|iendo|yendo)\b/i };
const TENSE={ PAST:"past", PRESENT:"present", FUTURE:"future", PROG:"progressive" };
function detectTense(es){ /* ...igual... */ }
function xorshift32(seed){ /* ...igual... */ }
function hashStr(s){ /* ...igual... */ }
const SYLL=[/* ...igual... */];
function synth(word){ /* ...igual... */ }
function learnPairs(pairs){ /* ...igual... */ }

/* ===================== TRADUCCI√ìN ===================== */
function tokensOf(text){ /* ...igual... */ }
function translateES2SIM(text){ /* ...igual... */ }
function translateSIM2ES(text){ /* ...igual... */ }

/* ===================== UI refs ===================== */
const $in=document.getElementById("in"), $out=document.getElementById("out");
const $btn=document.getElementById("translate"), $clear=document.getElementById("clear");
const $copy=document.getElementById("copy"), $demo=document.getElementById("demo");
const $toggleDir=document.getElementById("toggleDir"), $dirLabel=document.getElementById("dirLabel");
const $stateDirVal=document.getElementById("stateDirVal"), $stateLearnVal=document.getElementById("stateLearnVal");
const $meta=document.getElementById("meta"), $metaLex=document.getElementById("metaLex");
const $exportBtn=document.getElementById("exportBtn"), $history=document.getElementById("history");
const $confBadge=document.getElementById("confBadge"), $confCount=document.getElementById("confCount");
const $hostChip=document.getElementById("hostChip"), $hostState=document.getElementById("hostState");
const $strictBanner=document.getElementById("strictBanner");
const $confList=document.getElementById("confList");

/* NUEVOS refs import */
let $importJson, $importFile, $btnLoadFile, $btnPreviewImport, $btnDoImport, $importMode, $importInfo;

/* ===================== UI helpers ===================== */
function setDir(d){ /* ...igual... */ }

function renderConflictsList(conflicts){ /* ...igual... */ }

function refreshMeta(){ /* ...igual... */ }

/* ===================== BOTONES B√ÅSICOS ===================== */
$btn.addEventListener("click", doTranslate);
$clear.addEventListener("click", ()=>{ $in.value=""; $out.textContent="--"; lastLearnedCount=0; refreshMeta(); });
$copy.addEventListener("click", async ()=>{ /* ...igual... */ });
$demo.addEventListener("click", ()=>{ /* ...igual... */ });
$exportBtn.addEventListener("click", ()=>{ /* ...igual... */ });

/* ===================== CONFLICTOS UI ===================== */
$confBadge.addEventListener("click", ()=>{ /* ...igual... */ });

/* ===================== SECRET UNLOCK ===================== */
async function unlockPanelIfNeeded(){
  const panel=document.getElementById("secretPanel");
  if(panel && panel.style.display!=="none") return true;
  const fld = document.getElementById("secretPass");
  const pass = (fld?.value||"").trim();
  if(!pass){ alert("Ingresa la contrase√±a para administrar."); return false; }
  const ok = await verifyPass(pass);
  if(!ok){ alert("Contrase√±a incorrecta."); return false; }
  if(panel){ panel.style.display="block"; }
  if(fld) fld.value="";
  /* Inicializar refs de import al abrir */
  initImportRefs();
  return true;
}
document.getElementById("secretUnlock")?.addEventListener("click", async ()=>{
  await unlockPanelIfNeeded();
});

/* ===================== EDITOR ===================== */
function resultsFromQuery(q, mode){ /* ...igual... */ }
function renderResults(list){ /* ...igual... */ }
document.getElementById("btnSearch")?.addEventListener("click", ()=>{ /* ...igual... */ });
document.getElementById("btnGen")?.addEventListener("click", ()=>{ /* ...igual... */ });
document.getElementById("btnCreate")?.addEventListener("click", ()=>{ /* ...igual... */ });
document.getElementById("btnRescan")?.addEventListener("click", ()=>{ /* ...igual... */ });

function resolveConflictBySynonyms(sim){ /* ...igual... */ }

/* ===================== SYNC ===================== */
function updateHostIndicators(){ /* ...igual... */ }
function endpoint(){ return BACKEND_URL; }
function schedulePushToHost(){ /* ...igual... */ }
async function pushToHost(){ /* ...igual... */ }
async function pullFromHost(){ /* ...igual... */ }
function flushViaBeacon(){ /* ...igual... */ }
window.addEventListener("pagehide", flushViaBeacon);
document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==="hidden") flushViaBeacon(); });
window.addEventListener("beforeunload", flushViaBeacon);

/* ===================== TRADUCIR ===================== */
function doTranslate(){ /* ...igual... */ }

/* ===================== IMPORT: l√≥gica nueva ===================== */
function initImportRefs(){
  $importJson = document.getElementById("importJson");
  $importFile = document.getElementById("importFile");
  $btnLoadFile = document.getElementById("btnLoadFile");
  $btnPreviewImport = document.getElementById("btnPreviewImport");
  $btnDoImport = document.getElementById("btnDoImport");
  $importMode = document.getElementById("importMode");
  $importInfo = document.getElementById("importInfo");

  if(!$btnLoadFile || $btnLoadFile._bound){ return; } // evitar doble bind

  $btnLoadFile._bound = true;
  $btnLoadFile.addEventListener("click", async ()=>{
    if(!$importFile?.files?.length){ alert("Selecciona un archivo .json primero."); return; }
    const file = $importFile.files[0];
    const text = await file.text().catch(()=>null);
    if(!text){ alert("No se pudo leer el archivo."); return; }
    $importJson.value = text;
    $importInfo.textContent = "Archivo le√≠do. Puedes previsualizar o aplicar.";
  });

  $btnPreviewImport.addEventListener("click", ()=>{
    try{
      const parsed = normalizeBackupJSON($importJson.value);
      const stats = computeBackupStats(parsed);
      $importInfo.textContent = `Detectado: ES‚ÜíSIM: ${stats.es2sim} ¬∑ SIM‚ÜíES: ${stats.sim2es} ¬∑ Historial: ${stats.history}`;
    }catch(e){
      $importInfo.textContent = `Error: ${e.message}`;
    }
  });

  $btnDoImport.addEventListener("click", ()=>{
    try{
      const parsed = normalizeBackupJSON($importJson.value);
      const mode = ($importMode?.value)||"merge";
      if(mode === "replace"){
        if(!confirm("Vas a REEMPLAZAR completamente el diccionario de Usuario por el respaldo. ¬øContinuar?")) return;
      }
      const stats = applyBackup(parsed, mode);
      $importInfo.textContent = `Aplicado (${mode}). ES‚ÜíSIM: +${stats.appliedEs2Sim} ¬∑ SIM‚ÜíES: +${stats.appliedSim2Es} ¬∑ Historial: ${stats.historyApplied}`;
      refreshMeta();
      alert("Respaldo aplicado correctamente.");
    }catch(e){
      alert("No se aplic√≥ el respaldo: " + e.message);
    }
  });
}

function normalizeBackupJSON(text){
  if(!text || !text.trim()) throw new Error("JSON vac√≠o.");
  let obj;
  try{ obj = JSON.parse(text); }catch{ throw new Error("JSON inv√°lido."); }

  // Soportar dos variantes:
  // A) { core_version, user:{es2sim, sim2es}, history:[] }
  // B) { es2sim:{}, sim2es:{} } (+ opcional history)
  let userLike = null, historyLike = [];
  if(obj && obj.user && (obj.user.es2sim || obj.user.sim2es)){
    userLike = obj.user;
    if(Array.isArray(obj.history)) historyLike = obj.history.slice(-10);
  }else if(obj && (obj.es2sim || obj.sim2es)){
    userLike = { es2sim: obj.es2sim||{}, sim2es: obj.sim2es||{} };
    if(Array.isArray(obj.history)) historyLike = obj.history.slice(-10);
  }else{
    throw new Error("Formato no reconocido. Se esperaba {user:{es2sim,sim2es}} o {es2sim,sim2es}.");
  }

  // Normalizar tipos
  userLike.es2sim = userLike.es2sim || {};
  userLike.sim2es = userLike.sim2es || {};
  if(typeof userLike.es2sim !== "object" || typeof userLike.sim2es !== "object"){
    throw new Error("Estructura de diccionario inv√°lida.");
  }
  return { user: userLike, history: historyLike };
}

function computeBackupStats(parsed){
  const es2sim = Object.keys(parsed.user.es2sim||{}).length;
  const sim2es = Object.keys(parsed.user.sim2es||{}).length;
  const hist = Array.isArray(parsed.history)? parsed.history.length : 0;
  return { es2sim, sim2es, history: hist };
}

function applyBackup(parsed, mode){
  const srcES2SIM = parsed.user.es2sim||{};
  const srcSIM2ES = parsed.user.sim2es||{};
  const srcHIST   = Array.isArray(parsed.history)? parsed.history.slice(-10) : [];

  let appliedEs2Sim=0, appliedSim2Es=0, historyApplied=0;

  if(mode === "replace"){
    USER = { es2sim:{}, sim2es:{} };
  }

  // MERGE controlado: mantiene bijecci√≥n coherente
  for(const [es, sim] of Object.entries(srcES2SIM)){
    const kEs=normEs(es); let simVal=String(sim||"").trim();
    if(!kEs || !simVal) continue;
    simVal = ensureUniqueSim(simVal, es);
    const kSim = normSim(simVal);

    const prevSim = USER.es2sim[kEs];
    if(prevSim && normSim(prevSim)!==kSim){ delete USER.sim2es[normSim(prevSim)]; }
    const prevEs = USER.sim2es[kSim];
    if(prevEs && normEs(prevEs)!==kEs){ delete USER.es2sim[normEs(prevEs)]; }

    if(USER.es2sim[kEs]!==simVal){ appliedEs2Sim++; }
    USER.es2sim[kEs]=simVal;
    USER.sim2es[kSim]=es;
  }

  for(const [sim, es] of Object.entries(srcSIM2ES)){
    const kSim=normSim(sim); const esVal=String(es||"").trim();
    if(!kSim || !esVal) continue;
    const kEs=normEs(esVal);

    const prevSim = USER.es2sim[kEs];
    if(prevSim && normSim(prevSim)!==kSim){ delete USER.sim2es[normSim(prevSim)]; }
    const prevEs = USER.sim2es[kSim];
    if(prevEs && normEs(prevEs)!==kEs){ delete USER.es2sim[normEs(prevEs)]; }

    if(USER.sim2es[kSim]!==esVal){ appliedSim2Es++; }
    USER.sim2es[kSim]=esVal;
    USER.es2sim[kEs]=sim;
  }

  if(srcHIST.length){
    HISTORY = srcHIST.slice(-10);
    historyApplied = HISTORY.length;
  }

  saveUser(USER);
  saveHistory(HISTORY);
  return { appliedEs2Sim, appliedSim2Es, historyApplied };
}

/* ===================== INIT ===================== */
function init(){ setDir(DIR.ES2SIM); pullFromHost(); refreshMeta(); }
init();
</script>
</body>
</html>
